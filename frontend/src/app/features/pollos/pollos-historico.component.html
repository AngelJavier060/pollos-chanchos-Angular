<!-- Hist√≥rico de Alimentaci√≥n de Pollos -->
<div class="historico-alimentacion-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">üìö Historial de Alimentaci√≥n</h1>
      <p class="page-subtitle">Registro completo de alimentaci√≥n con datos reales del sistema</p>
    </div>
    <div class="header-actions">
      <button (click)="exportarDatos()" class="btn btn-export">
        <i class="fas fa-download"></i>
        Exportar Datos
      </button>
    </div>
  </div>

  <!-- Indicadores de Carga -->
  <div *ngIf="cargandoRegistros || cargandoEstadisticas" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <span>Cargando datos del historial...</span>
    </div>
  </div>

  <!-- Error de Carga -->
  <div *ngIf="errorCarga" class="error-container">
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <span>{{ errorCarga }}</span>
      <button (click)="cargarDatosHistoricos()" class="btn btn-retry">
        <i class="fas fa-redo"></i>
        Reintentar
      </button>
    </div>
  </div>

  <!-- Estad√≠sticas Generales -->
  <div class="estadisticas-generales" *ngIf="!cargandoRegistros">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon bg-blue-500">
          <i class="fas fa-list"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getEstadisticasGenerales().totalRegistros }}</h3>
          <p>Registros Totales</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon bg-green-500">
          <i class="fas fa-layer-group"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getEstadisticasGenerales().totalLotes }}</h3>
          <p>Lotes Involucrados</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon bg-yellow-500">
          <i class="fas fa-weight-hanging"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getEstadisticasGenerales().cantidadTotal.toFixed(2) }} kg</h3>
          <p>Cantidad Total</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon bg-purple-500">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getEstadisticasGenerales().promedioGeneral.toFixed(2) }} kg</h3>
          <p>Promedio por Registro</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de Rango de Fechas -->
  <div class="rango-fechas-container">
    <div class="rango-grid">
      <div class="fecha-group">
        <label class="fecha-label">üìÖ Fecha Inicio</label>
        <input 
          type="date" 
          [(ngModel)]="fechaInicio"
          class="fecha-input">
      </div>
      
      <div class="fecha-group">
        <label class="fecha-label">üìÖ Fecha Fin</label>
        <input 
          type="date" 
          [(ngModel)]="fechaFin"
          class="fecha-input">
      </div>
      
      <div class="fecha-group">
        <label class="fecha-label">&nbsp;</label>
        <button (click)="actualizarRangoFechas()" class="btn btn-primary">
          <i class="fas fa-sync-alt"></i>
          Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- Pesta√±as de Vista -->
  <div class="vista-tabs">
    <button 
      (click)="cambiarVista('registros')"
      [class]="'tab-button ' + (vistaActual === 'registros' ? 'active' : '')">
      <i class="fas fa-list"></i>
      Registros Individuales
    </button>
    <button 
      (click)="cambiarVista('estadisticas')"
      [class]="'tab-button ' + (vistaActual === 'estadisticas' ? 'active' : '')">
      <i class="fas fa-chart-bar"></i>
      Estad√≠sticas por Lote
    </button>
  </div>

  <!-- Vista de Registros Individuales -->
  <div *ngIf="vistaActual === 'registros'" class="vista-registros">
    <!-- Opciones de visualizaci√≥n -->
    <div class="opciones-visualizacion" style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
      <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#475569;">
        <input type="checkbox" [(ngModel)]="stickyHeader"> Encabezado fijo
      </label>
      <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#475569;">
        <input type="checkbox" [(ngModel)]="modoCompacto"> Modo compacto
      </label>
    </div>

    <!-- Filtros para Registros -->
    <div class="filtros-container">
      <div class="filtros-grid">
        <div class="filtro-group">
          <label class="filtro-label">üîç Buscar</label>
          <input 
            type="text" 
            [(ngModel)]="busqueda"
            placeholder="C√≥digo de lote, observaciones..."
            class="filtro-input">
        </div>
        
        <div class="filtro-group">
          <label class="filtro-label">üè∑Ô∏è Lote</label>
          <select [(ngModel)]="filtroLote" class="filtro-select">
            <option value="">Todos los lotes</option>
            <option *ngFor="let lote of getLotesUnicos()" [value]="lote.loteId">
              {{ lote.loteDescripcion }} ({{ lote.codigoLote }})
            </option>
          </select>
        </div>
        
        <!-- Nuevo: Buscador por fecha y hora de creaci√≥n -->
        <div class="filtro-group">
          <label class="filtro-label">‚è±Ô∏è Desde (fecha y hora)</label>
          <input 
            type="datetime-local" 
            [(ngModel)]="filtroFechaHoraInicio"
            class="filtro-input">
        </div>

        <div class="filtro-group">
          <label class="filtro-label">‚è±Ô∏è Hasta (fecha y hora)</label>
          <input 
            type="datetime-local" 
            [(ngModel)]="filtroFechaHoraFin"
            class="filtro-input">
        </div>

        <div class="filtro-group">
          <label class="filtro-label">üìä Estado</label>
          <select [(ngModel)]="filtroStatus" class="filtro-select">
            <option value="">Todos los estados</option>
            <option *ngFor="let status of getStatusUnicos()" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
        
        <div class="filtro-group">
          <label class="filtro-label">&nbsp;</label>
          <div style="display:flex; gap:8px;">
            <button (click)="aplicarFiltroFechaHora()" class="btn btn-primary">
              <i class="fas fa-search"></i>
              Buscar
            </button>
            <button class="btn btn-secondary" (click)="limpiarFiltros()">
              <i class="fas fa-eraser"></i>
              Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Registros -->
    <div class="tabla-registros" [class.sticky-head]="stickyHeader" [class.modo-compacto]="modoCompacto">
      <div class="table-header">
        <h2>üìã Registros de Alimentaci√≥n ({{ getRegistrosFiltrados().length }})</h2>
      </div>
      
      <div class="table-responsive" *ngIf="!cargandoRegistros">
        <table class="registros-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha de Creaci√≥n</th>
              <th>Lote</th>
              <th>Cantidad</th>
              <th>Animales Vivos</th>
              <th>Animales Muertos</th>
              <th>Estado</th>
              <th>Jornada</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let registro of getRegistrosPaginados(); trackBy: trackByRegistro" class="table-row">
              <td class="id-cell">
                <span class="id-badge">#{{ registro.id }}</span>
              </td>
              
              <td class="fecha-cell">
                <div class="fecha-info">
                  <div class="fecha-principal">{{ formatearFechaHora(registro.fechaCreacion) }}</div>
                </div>
              </td>
              
              <td class="lote-cell">
                <div class="lote-info">
                  <span class="lote-nombre">{{ registro.loteDescripcion }}</span>
                  <span class="lote-codigo">{{ registro.codigoLote }}</span>
                </div>
              </td>
              
              <td class="cantidad-cell">
                <div class="cantidad-info">
                  <span class="cantidad-valor">{{ registro.cantidadAplicada.toFixed(2) }} kg</span>
                  <div class="tipo-consumo" style="margin-top:4px; display:flex; align-items:center; gap:6px;">
                    <i [class]="getIconoTipoConsumo(registro)"></i>
                    <span class="tipo-label" style="font-size:12px; color:#475569;">{{ getEtiquetaTipoConsumo(registro) }}</span>
                    <ng-container *ngIf="getTotalManiana(registro) as totalM; else sinTotalM">
                      <span *ngIf="totalM > 0" class="total-maniana" style="margin-left:8px;">
                        <i class="fas fa-sun" style="margin-right:6px;"></i>
                        Ma√±ana: {{ totalM | number:'1.2-2' }} kg
                      </span>
                    </ng-container>
                    <ng-template #sinTotalM></ng-template>
                  </div>
                </div>
              </td>
              
              <td class="animales-vivos-cell">
                <ng-container *ngIf="getVivosDelDia(registro) as vivosDia; else noVivos">
                  <div class="animales-info">
                    <i class="fas fa-egg text-green-500"></i>
                    <span>{{ vivosDia }}</span>
                  </div>
                </ng-container>
                <ng-template #noVivos>
                  <span class="no-data">N/A</span>
                </ng-template>
              </td>
              
              <td class="animales-muertos-cell">
                <ng-container *ngIf="getMuertosDelDia(registro) as muertosDia; else noMuertos">
                  <ng-container *ngIf="muertosDia > 0; else sinMortalidad">
                    <div class="animales-info">
                      <i class="fas fa-skull text-red-500"></i>
                      <span>{{ muertosDia }}</span>
                    </div>
                  </ng-container>
                  <ng-template #sinMortalidad>
                    <span class="no-data">No hubo</span>
                  </ng-template>
                </ng-container>
                <ng-template #noMuertos>
                  <span class="no-data">No hubo</span>
                </ng-template>
              </td>
              
              <td class="status-cell">
                <div class="status-badge" [class]="getColorStatus(registro.status)">
                  <i [class]="getIconoStatus(registro.status)"></i>
                  <span>{{ registro.status }}</span>
                </div>
              </td>
              
              <td class="day-cell">
                <span class="day-badge">{{ getJornada(registro) }}</span>
              </td>
              
              <td class="observaciones-cell">
                <span class="observaciones-text" [title]="registro.observaciones">
                  {{ registro.observaciones || 'Sin observaciones' }}
                </span>
              </td>
              
              <td class="acciones-cell">
                <div class="acciones-container">
                  <button 
                    (click)="editarRegistro(registro)" 
                    class="btn-accion btn-editar"
                    title="Editar registro">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    (click)="eliminarRegistro(registro)" 
                    class="btn-accion btn-eliminar"
                    title="Eliminar registro">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button 
                    (click)="verDetalles(registro)" 
                    class="btn-accion btn-detalles"
                    title="Ver detalles">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- Mensaje si no hay datos -->
        <div *ngIf="getRegistrosFiltrados().length === 0" class="no-data-message">
          <i class="fas fa-inbox"></i>
          <h3>No hay registros</h3>
          <p>No se encontraron registros para los filtros seleccionados.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de Estad√≠sticas por Lote -->
  <div *ngIf="vistaActual === 'estadisticas'" class="vista-estadisticas">
    
    <div class="estadisticas-header">
      <h2>üìä Estad√≠sticas Agrupadas por Lote</h2>
      <p>M√©tricas consolidadas para cada lote</p>
    </div>

    <div class="estadisticas-grid" *ngIf="!cargandoEstadisticas">
      <div *ngFor="let lote of estadisticasPorLote" class="lote-card">
        <div class="lote-header">
          <h3>{{ lote.codigo }}</h3>
          <span class="lote-id">ID: {{ lote.loteId }}</span>
        </div>
        
        <div class="lote-periodo">
          <i class="fas fa-calendar"></i>
          <span>{{ formatearFecha(lote.fechaInicio) }} - {{ formatearFecha(lote.fechaUltimo) }}</span>
          <span class="dias-badge">{{ lote.diasActivos }} d√≠as</span>
        </div>
        
        <div class="lote-metricas">
          <div class="metrica">
            <i class="fas fa-list text-blue-500"></i>
            <span class="metrica-label">Registros</span>
            <span class="metrica-valor">{{ lote.totalRegistros }}</span>
          </div>
          
          <div class="metrica">
            <i class="fas fa-weight-hanging text-green-500"></i>
            <span class="metrica-label">Total</span>
            <span class="metrica-valor">{{ lote.cantidadTotal.toFixed(2) }} kg</span>
          </div>
          
          <div class="metrica">
            <i class="fas fa-chart-line text-yellow-500"></i>
            <span class="metrica-label">Promedio/d√≠a</span>
            <span class="metrica-valor">{{ lote.promedioDiario.toFixed(2) }} kg</span>
          </div>
          
          <div class="metrica">
            <i class="fas fa-heartbeat text-red-500"></i>
            <span class="metrica-label">Supervivencia</span>
            <span class="metrica-valor">{{ lote.tasaSupervivencia.toFixed(1) }}%</span>
          </div>
        </div>
        
        <div class="lote-animales">
          <div class="animal-stat">
            <i class="fas fa-egg text-green-600"></i>
            <span>{{ lote.animalesVivos }} vivos</span>
          </div>
          <div class="animal-stat">
            <i class="fas fa-skull text-red-600"></i>
            <span>{{ lote.animalesMuertos }} muertos</span>
          </div>
        </div>
      </div>
      
      <!-- Mensaje si no hay estad√≠sticas -->
      <div *ngIf="estadisticasPorLote.length === 0" class="no-stats-message">
        <i class="fas fa-chart-bar"></i>
        <h3>No hay estad√≠sticas disponibles</h3>
        <p>No se pudieron generar estad√≠sticas con los datos actuales.</p>
      </div>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <div class="paginacion-container" *ngIf="vistaActual === 'registros' && getTotalPaginas() > 1">
    <div class="paginacion">
      <button 
        (click)="cambiarPagina(paginaActual - 1)"
        [disabled]="paginaActual <= 1"
        class="btn btn-pagination">
        <i class="fas fa-chevron-left"></i>
        Anterior
      </button>
      
      <div class="pagina-info">
        <span>P√°gina {{ paginaActual }} de {{ getTotalPaginas() }}</span>
        <span class="registros-info">({{ getRegistrosFiltrados().length }} registros)</span>
      </div>
      
      <button 
        (click)="cambiarPagina(paginaActual + 1)"
        [disabled]="paginaActual >= getTotalPaginas()"
        class="btn btn-pagination">
        Siguiente
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Modal de Detalle de Alimento (solo MA√ëANA) -->
  <div *ngIf="mostrarDetalleAlimento" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
      <div class="p-5 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Alimentos (Ma√±ana)</h3>
        <button (click)="cerrarDetalleAlimento()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-5">
        <ng-container *ngIf="detalleAlimentos.length; else sinAlimentos">
          <div class="space-y-2">
            <div *ngFor="let item of detalleAlimentos" class="flex items-center justify-between">
              <span class="text-gray-800">{{ item.nombre }}</span>
              <span class="font-semibold">{{ item.total | number:'1.2-2' }} kg</span>
            </div>
          </div>
        </ng-container>
        <ng-template #sinAlimentos>
          <div class="text-sm text-gray-600">Sin registros de alimentos (Ma√±ana).</div>
        </ng-template>
      </div>
      <div class="p-4 border-t flex justify-end">
        <button (click)="cerrarDetalleAlimento()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalles del Registro -->
  <div *ngIf="mostrarModalDetalles && registroSeleccionado" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
      <div class="p-5 border-b bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-t-xl flex items-center justify-between">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <i class="fas fa-clipboard-list"></i>
          DETALLES DEL REGISTRO #{{ registroSeleccionado.id }}
        </h3>
        <button (click)="cerrarModalDetalles()" class="text-white hover:text-gray-200 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-5 space-y-4">
        <!-- Informaci√≥n del Lote -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-tag text-green-600"></i>
            <span class="font-semibold text-green-800">Lote</span>
          </div>
          <p class="text-lg font-bold text-green-900">{{ registroSeleccionado.loteDescripcion }}</p>
          <p class="text-sm text-green-700">C√≥digo: {{ registroSeleccionado.codigoLote }}</p>
        </div>

        <!-- Fechas -->
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-blue-700 mb-1">
              <i class="fas fa-calendar"></i>
              <span class="text-sm font-medium">Fecha de Registro</span>
            </div>
            <p class="font-semibold text-blue-900">{{ formatearFecha(registroSeleccionado.fecha) }}</p>
          </div>
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-purple-700 mb-1">
              <i class="fas fa-clock"></i>
              <span class="text-sm font-medium">Fecha de Creaci√≥n</span>
            </div>
            <p class="font-semibold text-purple-900">{{ formatearFechaHora(registroSeleccionado.fechaCreacion) }}</p>
          </div>
        </div>

        <!-- Productos Consumidos -->
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-3">
            <i class="fas fa-utensils text-orange-600"></i>
            <span class="font-semibold text-orange-800">Productos Consumidos</span>
          </div>
          <div *ngIf="productosConsumidos.length > 0; else sinProductos" class="space-y-2">
            <div *ngFor="let producto of productosConsumidos" class="flex items-center justify-between bg-white rounded-lg px-3 py-2 border border-orange-100">
              <div class="flex items-center gap-2">
                <i class="fas fa-seedling text-green-500"></i>
                <span class="font-medium text-gray-800">{{ producto.nombre }}</span>
              </div>
              <div class="text-right">
                <span class="font-bold text-orange-700">{{ producto.cantidad | number:'1.2-2' }} kg</span>
              </div>
            </div>
          </div>
          <ng-template #sinProductos>
            <p class="text-sm text-orange-600 italic">No se encontraron productos espec√≠ficos en este registro.</p>
          </ng-template>
        </div>

        <!-- Cantidad Total (suma de productos consumidos) -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-weight-hanging text-yellow-600"></i>
            <span class="font-semibold text-yellow-800">Cantidad Total</span>
          </div>
          <p class="text-2xl font-bold text-yellow-900">{{ getTotalProductosConsumidos() | number:'1.2-2' }} kg</p>
        </div>

        <!-- Animales -->
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-green-700 mb-1">
              <i class="fas fa-heart"></i>
              <span class="text-sm font-medium">Animales Vivos</span>
            </div>
            <p class="text-xl font-bold text-green-900">{{ registroSeleccionado.animalesVivos || 'N/A' }}</p>
          </div>
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-red-700 mb-1">
              <i class="fas fa-skull-crossbones"></i>
              <span class="text-sm font-medium">Animales Muertos</span>
            </div>
            <p class="text-xl font-bold text-red-900">{{ registroSeleccionado.animalesMuertos || 'N/A' }}</p>
          </div>
        </div>

        <!-- Estado y Jornada -->
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-gray-700 mb-1">
              <i class="fas fa-info-circle"></i>
              <span class="text-sm font-medium">Estado</span>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-semibold" [class]="getColorStatus(registroSeleccionado.status)">
              {{ registroSeleccionado.status }}
            </span>
          </div>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
            <div class="flex items-center gap-2 text-gray-700 mb-1">
              <i class="fas fa-sun"></i>
              <span class="text-sm font-medium">Jornada</span>
            </div>
            <p class="font-semibold text-gray-900">{{ getJornada(registroSeleccionado) }}</p>
          </div>
        </div>

        <!-- Observaciones -->
        <div *ngIf="registroSeleccionado.observaciones" class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <i class="fas fa-comment-alt text-gray-600"></i>
            <span class="font-semibold text-gray-800">Observaciones</span>
          </div>
          <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ registroSeleccionado.observaciones }}</p>
        </div>
      </div>
      
      <div class="p-4 border-t flex justify-end">
        <button (click)="cerrarModalDetalles()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
          Aceptar
        </button>
      </div>
    </div>
  </div>

</div>