<!-- Encabezado -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
  <div>
    <h1 style="margin: 0; font-size: 32px; font-weight: bold; color: #1f2937;"> Gesti贸n de Lotes</h1>
    <p style="margin: 5px 0 0 0; color: #6b7280;">Control de consumo por lote</p>
  </div>
</div>

<!-- Indicador de carga -->
<div *ngIf="loading" style="text-align: center; padding: 40px;">
  <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;"></div>
</div>

<ng-container *ngIf="!loading">
  <!-- Estad铆sticas Generales -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Lotes -->
    <div class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-400 p-6 rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-4xl font-bold text-blue-700 mb-2">{{ estadisticas.totalLotes }}</div>
          <div class="text-gray-700 font-medium">Total Lotes</div>
          <div class="text-sm text-gray-500 mt-1">Registrados en sistema</div>
        </div>
        <div class="p-4 bg-blue-200 rounded-full">
          <i class="fas fa-list-alt text-blue-600 text-2xl"></i>
        </div>
      </div>
    </div>
    
    <!-- Lotes Activos -->
    <div class="stat-card bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-400 p-6 rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-4xl font-bold text-green-700 mb-2">{{ estadisticas.lotesActivos }}</div>
          <div class="text-gray-700 font-medium">Lotes Activos</div>
          <div class="text-sm text-gray-500 mt-1">En producci贸n</div>
        </div>
        <div class="p-4 bg-green-200 rounded-full">
          <i class="fas fa-heart text-green-600 text-2xl"></i>
        </div>
      </div>
    </div>
    
    <!-- Animales Vivos -->
    <div class="stat-card bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-400 p-6 rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-4xl font-bold text-yellow-700 mb-2">{{ estadisticas.animalesVivos }}</div>
          <div class="text-gray-700 font-medium">Animales Vivos</div>
          <div class="text-sm text-gray-500 mt-1">Total en producci贸n</div>
        </div>
        <div class="p-4 bg-yellow-200 rounded-full">
          <i class="fas fa-drumstick-bite text-yellow-600 text-2xl"></i>
        </div>
      </div>
    </div>
    
    <!-- Rendimiento Promedio -->
    <div class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-400 p-6 rounded-xl shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-4xl font-bold text-purple-700 mb-2">{{ estadisticas.rendimientoPromedio }}%</div>
          <div class="text-gray-700 font-medium">Rendimiento</div>
          <div class="text-sm text-gray-500 mt-1">Promedio general</div>
        </div>
        <div class="p-4 bg-purple-200 rounded-full">
          <i class="fas fa-chart-line text-purple-600 text-2xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros y B煤squeda -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
      <i class="fas fa-filter mr-2 text-gray-600"></i>
      Filtros y B煤squeda
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- B煤squeda -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
        <div class="relative">
          <input 
            type="text" 
            [(ngModel)]="terminoBusqueda"
            (input)="onBusquedaChange($event)"
            placeholder="C贸digo, nombre o raza..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
      
      <!-- Filtro por Estado -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
        <select 
          [(ngModel)]="filtroEstado"
          (change)="onFiltroChange()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="todos">Todos los estados</option>
          <option value="activos">Solo activos</option>
          <option value="finalizados">Solo finalizados</option>
        </select>
      </div>
      
      <!-- Filtro por Raza -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Raza</label>
        <select 
          [(ngModel)]="filtroRaza"
          (change)="onFiltroChange()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="todos">Todas las razas</option>
          <option *ngFor="let raza of razasDisponibles" [value]="raza">{{ raza }}</option>
        </select>
      </div>
      
      <!-- Acciones -->
      <div class="flex items-end">
        <button 
          (click)="limpiarFiltros()"
          class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">
          <i class="fas fa-eraser mr-2"></i>
          Limpiar
        </button>
      </div>
    </div>
    
    <!-- Resultados de filtros -->
    <div class="mt-4 text-sm text-gray-600 flex items-center justify-between">
      <span>
        <i class="fas fa-info-circle mr-1 text-blue-500"></i>
        Mostrando {{ lotesFiltrados.length }} de {{ lotesPollos.length }} lotes
      </span>
      <span *ngIf="terminoBusqueda || filtroEstado !== 'todos' || filtroRaza !== 'todos'" class="text-blue-600 font-medium">
        Filtros aplicados
      </span>
    </div>
  </div>

  <!-- Lista de Lotes -->
  <div style="margin-bottom: 20px;">
    <!-- Lotes Expandibles -->
    <div *ngFor="let lote of lotesFiltrados; trackBy: trackByLote" 
         style="background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
      
      <!-- Header clickeable -->
      <div (click)="toggleExpand(lote)" 
           style="background: #fef3c7; color: #92400e; padding: 20px; border-radius: 12px 12px 0 0; cursor: pointer;">
        <h2 style="font-size: 24px; margin: 0;">{{ lote.codigo }} - {{ lote.name }}</h2>
        <p style="margin: 5px 0 0 0; opacity: 0.9;">
          {{ lote.quantity }} animales - Total: {{ getConsumoTotal(lote) | number:'1.2-2' }} kg
        </p>
      </div>

      <!-- Contenido expandible -->
      <div *ngIf="isExpanded(lote)" style="padding: 20px;">
        <!-- KPIs principales -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <!-- Consumo Total -->
          <div style="flex: 1; background: #fef3c7; padding: 20px; border-radius: 10px; border: 2px solid #fbbf24;">
            <div style="font-size: 14px; margin-bottom: 5px;">Consumo Total</div>
            <div style="font-size: 32px; font-weight: bold;">{{ getConsumoTotal(lote) | number:'1.2-2' }}</div>
            <div style="font-size: 12px; margin-top: 5px;">kilogramos</div>
          </div>

          <!-- Animales -->
          <div style="flex: 1; background: #dcfce7; padding: 20px; border-radius: 10px; border: 2px solid #86efac;">
            <div style="font-size: 14px; margin-bottom: 5px;">Animales</div>
            <div style="font-size: 32px; font-weight: bold;">{{ lote.quantity }}</div>
            <div style="font-size: 12px; margin-top: 5px;">cabezas</div>
          </div>

          <!-- Promedio -->
          <div style="flex: 1; background: #dbeafe; padding: 20px; border-radius: 10px; border: 2px solid #93c5fd;">
            <div style="font-size: 14px; margin-bottom: 5px;">Promedio</div>
            <div style="font-size: 32px; font-weight: bold;">{{ getPromedioPorAnimal(lote) | number:'1.2-2' }}</div>
            <div style="font-size: 12px; margin-top: 5px;">kg/animal</div>
          </div>

          <!-- KPI por producto (primeros 3) -->
          <ng-container *ngFor="let producto of getProductosDelLote(lote) | slice:0:3; let i = index">
            <div [ngStyle]="getKPIStyle(producto.nombre, i)" 
                 style="flex: 1; padding: 20px; border-radius: 10px;">
              <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600; opacity: .9;">{{ producto.nombre }}</div>
              <div style="font-size: 32px; font-weight: bold;">{{ producto.cantidad | number:'1.2-2' }}</div>
              <div style="font-size: 12px; margin-top: 5px;">kilogramos</div>
              <div style="background: rgba(255,255,255,.5); height: 8px; border-radius: 10px; margin-top: 10px;">
                <div [style.width.%]="getPorcentajeProducto(lote, producto)" 
                     style="height: 8px; border-radius: 10px; background: rgba(16,185,129,.8);"></div>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Tipos de Alimento (KPI por producto) -->
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Tipos de Alimento</h3>
        <div *ngIf="getProductosDelLote(lote)?.length; else sinAlimentos" 
             style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
          <div *ngFor="let producto of getProductosDelLote(lote); let i = index" 
               [ngStyle]="getKPIStyle(producto.nombre, i)"
               style="flex: 1 1 220px; padding: 20px; border-radius: 10px;">
            <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600; opacity: .9;">
              {{ producto.nombre | uppercase }}
            </div>
            <div style="font-size: 28px; font-weight: bold;">{{ producto.cantidad | number:'1.2-2' }} kg</div>
            <div style="background: rgba(255,255,255,.5); height: 8px; border-radius: 10px; margin-top: 10px;">
              <div [style.width.%]="getPorcentajeProducto(lote, producto)"
                   style="height: 8px; border-radius: 10px; background: rgba(16,185,129,.8);"></div>
            </div>
            <div style="font-size: 12px; margin-top: 5px;">{{ getPorcentajeProducto(lote, producto) }}% del total</div>
          </div>
        </div>
        
        <ng-template #sinAlimentos>
          <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #e5e7eb; text-align: center; color: #666;">
            No hay registros de alimentos para este lote
          </div>
        </ng-template>

        <!-- Historial -->
        <h3 style="margin-top: 30px; margin-bottom: 15px;">Historial</h3>
        <div *ngIf="getRegistrosDelLote(lote)?.length; else sinHistorial" style="background: #f9fafb; border-radius: 10px; overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f9fafb;">
                <th style="padding: 12px; text-align: left; font-size: 12px;">FECHA</th>
                <th style="padding: 12px; text-align: left; font-size: 12px;">TIPO</th>
                <th style="padding: 12px; text-align: left; font-size: 12px;">CANTIDAD</th>
                <th style="padding: 12px; text-align: left; font-size: 12px;">RESPONSABLE</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let registro of getRegistrosDelLote(lote) | slice:0:5">
                <td style="padding: 12px; border-top: 1px solid #e5e7eb;">{{ registro.fecha | date:'yyyy-MM-dd HH:mm' }}</td>
                <td style="padding: 12px; border-top: 1px solid #e5e7eb;">{{ getNombreProductoRegistro(registro) }}</td>
                <td style="padding: 12px; border-top: 1px solid #e5e7eb;">{{ registro.cantidad | number:'1.2-2' }} kg</td>
                <td style="padding: 12px; border-top: 1px solid #e5e7eb;">{{ registro.usuarioNombre || 'Sistema' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <ng-template #sinHistorial>
          <div style="background: #f9fafb; padding: 15px; border-radius: 10px; border: 1px solid #e5e7eb; text-align: center; color: #666;">
            No hay registros de historial para este lote
          </div>
        </ng-template>
      </div>
    </div>

    <!-- No hay lotes -->
    <div *ngIf="lotesFiltrados.length === 0" class="text-center py-16 bg-white rounded-xl shadow-lg border border-gray-200">
      <i class="fas fa-search text-gray-300 text-8xl mb-6"></i>
      <h3 class="text-2xl font-bold text-gray-600 mb-4">No se encontraron lotes</h3>
      <p class="text-gray-500 text-lg mb-6" *ngIf="terminoBusqueda || filtroEstado !== 'todos' || filtroRaza !== 'todos'">
        No hay lotes que coincidan con los filtros aplicados
      </p>
      <p class="text-gray-500 text-lg mb-6" *ngIf="!terminoBusqueda && filtroEstado === 'todos' && filtroRaza === 'todos'">
        No hay lotes de pollos registrados en el sistema
      </p>
      <div class="space-x-3">
        <button 
          (click)="limpiarFiltros()"
          *ngIf="terminoBusqueda || filtroEstado !== 'todos' || filtroRaza !== 'todos'"
          class="btn-professional bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg">
          <i class="fas fa-eraser mr-2"></i>
          Limpiar Filtros
        </button>
        <button 
          (click)="cargarDatosIniciales()"
          class="btn-professional bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg">
          <i class="fas fa-sync mr-2"></i>
          Actualizar Datos
        </button>
      </div>
    </div>
  </div>
</ng-container>