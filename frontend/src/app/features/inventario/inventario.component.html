<div class="p-6 bg-white rounded-lg shadow-md">
  <!-- Encabezado -->
  <div class="text-center mb-6" *ngIf="!botiquinOnly">
    <h1 class="text-3xl font-bold text-blue-800">Gesti√≥n de Inventario</h1>
    <p class="text-gray-600 mt-2">Administra los productos e insumos del sistema av√≠cola</p>
  </div>

  <!-- Navegaci√≥n entre vistas (SIEMPRE VISIBLE ARRIBA) -->
  <div class="flex justify-center mb-6" *ngIf="!botiquinOnly">
    <div class="bg-gray-100 rounded-lg p-1 shadow-sm">
      <button 
        (click)="cambiarVista('productos')" 
        [ngClass]="vistaActual === 'productos' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 hover:bg-gray-200'"
        class="px-4 py-2 rounded-md transition-all duration-200 font-medium">
        <i class="fas fa-boxes mr-2"></i>Productos
      </button>
      <button 
        (click)="cambiarVista('stock-real')" 
        [ngClass]="vistaActual === 'stock-real' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 hover:bg-gray-200'"
        class="px-4 py-2 rounded-md transition-all duration-200 font-medium">
        <i class="fas fa-chart-line mr-2"></i>Stock Real
      </button>
      <button 
        (click)="cambiarVista('entradas')" 
        [ngClass]="vistaActual === 'entradas' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 hover:bg-gray-200'"
        class="px-4 py-2 rounded-md transition-all duration-200 font-medium">
        <i class="fas fa-inbox mr-2"></i>Entradas
      </button>
      <button 
        (click)="cambiarVista('alertas')" 
        [ngClass]="vistaActual === 'alertas' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 hover:bg-gray-200'"
        class="px-4 py-2 rounded-md transition-all duration-200 font-medium">
        <i class="fas fa-bell mr-2"></i>Alertas
      </button>
    </div>
  </div>
  
  <!-- Vista de Botiqu√≠n -->
  <div *ngIf="vistaActual === 'productos' && botiquinOnly">
    <!-- Header Botiqu√≠n -->
    <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-3">
            <span class="text-3xl md:text-4xl">üè•</span>
            Botiqu√≠n Veterinario
          </h1>
          <p class="text-gray-600 mt-2">Control de medicamentos e insumos de emergencia</p>
        </div>
        <button (click)="openForm(false)" class="px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-white transition-all hover:-translate-y-0.5 hover:shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          + Agregar Producto
        </button>
      </div>
    </div>

    <!-- Entradas vigentes del producto -->
    <div class="bg-white border border-green-200 rounded-lg p-6 shadow-sm mt-4" *ngIf="selectedProductIdEntradas">
      <h3 class="text-lg font-semibold text-green-800 mb-3">
        <i class="fas fa-check-circle mr-2"></i>Entradas vigentes del producto
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingreso</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vence</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock base</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unidades</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidad ctrl</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let e of getEntradasVigentesSeleccionado()">
              <td class="px-4 py-2">{{ e.codigoLote || '-' }}</td>
              <td class="px-4 py-2">{{ e.fechaIngreso ? (toDate(e.fechaIngreso) | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="px-4 py-2">{{ e.fechaVencimiento ? (toDate(e.fechaVencimiento) | date:'MM/yyyy') : '-' }}</td>
              <td class="px-4 py-2 text-right">{{ (e.stockBaseRestante || 0) | number:'1.0-2' }}</td>
              <td class="px-4 py-2 text-right">{{ (e.stockUnidadesRestantes || 0) | number:'1.0-2' }}</td>
              <td class="px-4 py-2">{{ e.unidadControl || '-' }}</td>
            </tr>
            <tr *ngIf="getEntradasVigentesSeleccionado().length === 0">
              <td colspan="6" class="px-4 py-3 text-center text-sm text-gray-500">Sin entradas vigentes</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Hist√≥rico de entradas del producto -->
    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mt-4" *ngIf="selectedProductIdEntradas">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">
        <i class="fas fa-archive mr-2"></i>Hist√≥rico de entradas (cerradas / vencidas / agotadas)
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingreso</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Restante</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let e of getEntradasHistoricoSeleccionado()">
              <td class="px-4 py-2">{{ e.codigoLote || '-' }}</td>
              <td class="px-4 py-2">{{ e.fechaIngreso ? (toDate(e.fechaIngreso) | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="px-4 py-2">{{ e.fechaVencimiento ? (toDate(e.fechaVencimiento) | date:'MM/yyyy') : '-' }}</td>
              <td class="px-4 py-2 text-right">{{ (e.stockBaseRestante || 0) | number:'1.0-2' }}</td>
              <td class="px-4 py-2">
                <span class="px-2 py-1 rounded text-xs font-medium" [ngClass]="(e?.activo === false) ? 'bg-gray-200 text-gray-700' : 'bg-yellow-100 text-yellow-700'">
                  {{ (e?.activo === false) ? 'Cerrada' : 'No vigente' }}
                </span>
              </td>
            </tr>
            <tr *ngIf="getEntradasHistoricoSeleccionado().length === 0">
              <td colspan="5" class="px-4 py-3 text-center text-sm text-gray-500">Sin hist√≥rico de entradas</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Movimientos del producto seleccionado -->
    <div class="bg-white border border-blue-200 rounded-lg p-6 shadow-sm mt-4" *ngIf="selectedProductIdEntradas">
      <h3 class="text-lg font-semibold text-blue-800 mb-3">
        <i class="fas fa-history mr-2"></i>Movimientos del producto
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock anterior</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock nuevo</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let m of movimientosProducto">
              <td class="px-4 py-2">{{ m.fechaMovimiento ? (toDate(m.fechaMovimiento) | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
              <td class="px-4 py-2">{{ m.tipoMovimiento }}</td>
              <td class="px-4 py-2 text-right">{{ (m.cantidad || 0) | number:'1.0-2' }}</td>
              <td class="px-4 py-2 text-right">{{ (m.stockAnterior || 0) | number:'1.0-2' }}</td>
              <td class="px-4 py-2 text-right">{{ (m.stockNuevo || 0) | number:'1.0-2' }}</td>
            </tr>
            <tr *ngIf="movimientosProducto.length === 0">
              <td colspan="5" class="px-4 py-3 text-center text-sm text-gray-500">Sin movimientos</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Total</p>
            <p class="text-2xl md:text-3xl font-bold text-gray-800">{{ getBotStats().total }}</p>
          </div>
          <div class="text-2xl md:text-4xl">üì¶</div>
        </div>
      </div>
      <div class="bg-green-50 rounded-xl shadow-lg p-4 border-2 border-green-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-700 text-sm font-medium">Disponibles</p>
            <p class="text-2xl md:text-3xl font-bold text-green-600">{{ getBotStats().ok }}</p>
          </div>
          <div class="text-2xl md:text-4xl">‚úÖ</div>
        </div>
      </div>
      <div class="bg-yellow-50 rounded-xl shadow-lg p-4 border-2 border-yellow-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-yellow-700 text-sm font-medium">Alerta</p>
            <p class="text-2xl md:text-3xl font-bold text-yellow-600">{{ getBotStats().alerta }}</p>
          </div>
          <div class="text-2xl md:text-4xl">‚ö°</div>
        </div>
      </div>
      <div class="bg-orange-50 rounded-xl shadow-lg p-4 border-2 border-orange-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-700 text-sm font-medium">Bajo Stock</p>
            <p class="text-2xl md:text-3xl font-bold text-orange-600">{{ getBotStats().bajo }}</p>
          </div>
          <div class="text-2xl md:text-4xl">‚ö†Ô∏è</div>
        </div>
      </div>
      <div class="bg-red-50 rounded-xl shadow-lg p-4 border-2 border-red-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-red-700 text-sm font-medium">Agotados</p>
            <p class="text-2xl md:text-3xl font-bold text-red-600">{{ getBotStats().agotado }}</p>
          </div>
          <div class="text-2xl md:text-4xl">üî¥</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
      <div class="flex flex-col gap-4">
        <div class="relative">
          <input type="text" [(ngModel)]="botSearch" placeholder="üîç Buscar por nombre, uso, dosis..." class="w-full px-5 py-3 pl-12 border-2 border-gray-300 rounded-lg text-base focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all">
          <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl">üîç</span>
        </div>
        <div class="flex gap-4 items-center flex-wrap">
          <span class="text-gray-700 font-medium">Filtrar por:</span>
          <select [(ngModel)]="botFiltroCategoria" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
            <option value="todos">Todas las categor√≠as</option>
            <option *ngFor="let type of typeFoods" [value]="type.name">{{ type.name }}</option>
          </select>
          <select [(ngModel)]="botFiltroEstado" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500">
            <option value="todos">Todos los estados</option>
            <option value="ok">‚úÖ Disponibles</option>
            <option value="alerta">‚ö° En Alerta</option>
            <option value="bajo">‚ö†Ô∏è Bajo Stock</option>
            <option value="agotado">üî¥ Agotados</option>
          </select>
          <div class="ml-auto text-sm text-gray-600">
            Mostrando {{ getProductosBotiquinFiltrados().length }} de {{ getProductosBotiquin().length }} productos
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de productos Botiqu√≠n -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white">
            <tr>
              <th class="px-4 py-4 text-left text-sm font-semibold">Estado</th>
              <th class="px-4 py-4 text-left text-sm font-semibold">Producto</th>
              <th class="px-4 py-4 text-left text-sm font-semibold">Categor√≠a</th>
              <th class="px-4 py-4 text-left text-sm font-semibold">Animal</th>
              <th class="px-4 py-4 text-center text-sm font-semibold">Stock</th>
              <th class="px-4 py-4 text-center text-sm font-semibold">Nivel M√≠n.</th>
              <th class="px-4 py-4 text-left text-sm font-semibold">Uso Principal</th>
              <th class="px-4 py-4 text-center text-sm font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let p of getProductosBotiquinFiltrados(); trackBy: trackByProductId" class="hover:bg-gray-50 transition-colors">
              <td class="px-4 py-4">
                <div class="flex flex-col items-center">
                  <span class="text-2xl">{{ getBotEstadoMeta(p).icon }}</span>
                  <span class="text-xs font-semibold" [ngClass]="getBotEstadoMeta(p).colorClass">{{ getBotEstadoMeta(p).texto }}</span>
                </div>
              </td>
              <td class="px-4 py-4">
                <div class="font-semibold text-gray-800">{{ p.name }}</div>
              </td>
              <td class="px-4 py-4">
                <div class="text-sm text-gray-800">{{ p.typeFood?.name || getTypeFoodName(p.typeFood_id) }}</div>
                <div class="text-xs text-gray-500">{{ $any(p)?.subcategory?.name || '-' }}</div>
              </td>
              <td class="px-4 py-4 text-center">
                <span class="text-lg">{{ p.animal?.name || '-' }}</span>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="text-lg font-bold" [ngClass]="getBotEstadoMeta(p).colorClass">{{ getCantidadRealProducto(p) | number:'1.0-2' }}</div>
                <div class="text-xs text-gray-500">{{ p.unitMeasurement?.name || getUnitMeasurementName(p.unitMeasurement_id) }}</div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="text-sm text-gray-600">{{ p.level_min }}</div>
                <div class="text-xs text-gray-400">{{ p.unitMeasurement?.name || getUnitMeasurementName(p.unitMeasurement_id) }}</div>
              </td>
              <td class="px-4 py-4">
                <div class="text-sm text-gray-700 max-w-xs">{{ $any(p)?.usoPrincipal || '-' }}</div>
                <div *ngIf="$any(p)?.dosisRecomendada" class="text-xs text-purple-600 mt-1">üíâ {{ $any(p)?.dosisRecomendada }}</div>
              </td>
              <td class="px-4 py-4">
                <div class="flex justify-center gap-2">
                  <button (click)="openForm(true, p)" class="px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition-colors">‚úèÔ∏è Editar</button>
                  <button *ngIf="getBotEstado(p) !== 'ok'" (click)="reponerProducto(p)" class="px-3 py-1 bg-orange-500 text-white text-xs rounded-lg hover:bg-orange-600 transition-colors">üõí Reabastecer</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<!-- Vista de CENTRO DE ALERTAS - Reestructurado -->
<div *ngIf="vistaActual === 'alertas' && !botiquinOnly" class="space-y-6">
  
  <!-- Encabezado del Centro de Alertas -->
  <div class="bg-gradient-to-r from-gray-800 to-gray-700 text-white rounded-lg p-6 shadow-lg">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold flex items-center">
          <i class="fas fa-bell text-yellow-400 mr-3 animate-pulse"></i>
          Centro de Alertas de Inventario
        </h2>
        <p class="text-gray-300 mt-1">Panel de control para gesti√≥n proactiva del stock</p>
      </div>
      <div class="flex items-center space-x-3">
        <div class="flex items-center bg-gray-600 rounded-lg px-3 py-2">
          <label class="text-sm text-gray-300 mr-2">D√≠as alerta:</label>
          <input type="number" class="w-16 p-1 bg-gray-700 text-white border border-gray-500 rounded text-center" [(ngModel)]="diasAlertaPorVencer">
        </div>
        <button (click)="cargarAlertasEntradas(diasAlertaPorVencer); calcularAlertasProductos()" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          <i class="fas fa-sync-alt mr-2"></i>Actualizar
        </button>
      </div>
    </div>
    
    <!-- Resumen r√°pido -->
    <div class="grid grid-cols-4 gap-4 mt-4">
      <div class="bg-red-600/30 rounded-lg p-3 text-center">
        <p class="text-3xl font-bold">{{ productosAgotados.length }}</p>
        <p class="text-xs text-red-200">Agotados</p>
      </div>
      <div class="bg-yellow-600/30 rounded-lg p-3 text-center">
        <p class="text-3xl font-bold">{{ productosCriticos.length }}</p>
        <p class="text-xs text-yellow-200">Cr√≠ticos</p>
      </div>
      <div class="bg-orange-600/30 rounded-lg p-3 text-center">
        <p class="text-3xl font-bold">{{ alertasPorVencer.length }}</p>
        <p class="text-xs text-orange-200">Por Vencer</p>
      </div>
      <div class="bg-gray-600/30 rounded-lg p-3 text-center">
        <p class="text-3xl font-bold">{{ alertasVencidas.length }}</p>
        <p class="text-xs text-gray-300">Vencidos</p>
      </div>
    </div>
  </div>

  <!-- 1. PRODUCTOS AGOTADOS (Prioridad M√°xima) -->
  <div class="bg-white border-l-4 border-red-500 rounded-lg shadow-md overflow-hidden">
    <div class="bg-red-50 px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-bold text-red-800 flex items-center">
        <i class="fas fa-times-circle mr-2 text-red-600 animate-pulse"></i>
        ‚õî PRODUCTOS AGOTADOS ({{ productosAgotados.length }})
        <span class="ml-3 text-sm font-normal text-red-600">‚Äî Requieren reposici√≥n inmediata</span>
      </h3>
    </div>
    <div class="p-4">
      <div *ngIf="productosAgotados.length === 0" class="text-center py-6 text-gray-500">
        <i class="fas fa-check-circle text-green-500 text-3xl mb-2"></i>
        <p>¬°Ning√∫n producto agotado! Stock disponible para todos los productos.</p>
      </div>
      <div *ngIf="productosAgotados.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock M√≠nimo</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Sugerido a Reponer</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acci√≥n</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let p of productosAgotados" class="bg-red-50 hover:bg-red-100">
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">{{ p.name }}</div>
                <div class="text-xs text-gray-500">{{ p.animal?.name || 'General' }}</div>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600">{{ p.typeFood?.name || '-' }}</td>
              <td class="px-4 py-3 text-right text-sm text-purple-600 font-medium">
                {{ p.level_min || 0 }} {{ p.unitMeasurement?.name || 'kg' }}
              </td>
              <td class="px-4 py-3 text-right">
                <span class="text-lg font-bold text-red-600">{{ getCantidadSugerida(p) | number:'1.0-2' }}</span>
                <span class="text-xs text-gray-500 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              <td class="px-4 py-3 text-center">
                <button (click)="reponerProducto(p)" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium animate-pulse">
                  <i class="fas fa-plus mr-1"></i>REPONER AHORA
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 2. STOCK CR√çTICO (Por debajo del m√≠nimo) -->
  <div class="bg-white border-l-4 border-yellow-500 rounded-lg shadow-md overflow-hidden">
    <div class="bg-yellow-50 px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-bold text-yellow-800 flex items-center">
        <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>
        ‚ö†Ô∏è STOCK CR√çTICO ({{ productosCriticos.length }})
        <span class="ml-3 text-sm font-normal text-yellow-600">‚Äî Por debajo del stock m√≠nimo</span>
      </h3>
    </div>
    <div class="p-4">
      <div *ngIf="productosCriticos.length === 0" class="text-center py-6 text-gray-500">
        <i class="fas fa-thumbs-up text-green-500 text-3xl mb-2"></i>
        <p>Todos los productos est√°n por encima del stock m√≠nimo.</p>
      </div>
      <div *ngIf="productosCriticos.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock Actual</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock M√≠nimo</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">% Restante</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acci√≥n</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let p of productosCriticos" class="hover:bg-yellow-50">
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">{{ p.name }}</div>
                <div class="text-xs text-gray-500">{{ p.typeFood?.name || '-' }}</div>
              </td>
              <td class="px-4 py-3 text-right">
                <span class="font-bold text-yellow-600">{{ getCantidadRealProducto(p) | number:'1.0-2' }}</span>
                <span class="text-xs text-gray-500 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              <td class="px-4 py-3 text-right text-sm text-purple-600">
                {{ p.level_min || 0 }} {{ p.unitMeasurement?.name || 'kg' }}
              </td>
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">
                  {{ getPorcentajeStockProducto(p) }}%
                </span>
              </td>
              <td class="px-4 py-3 text-center">
                <button (click)="reponerProducto(p)" 
                        class="px-3 py-1.5 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm font-medium">
                  <i class="fas fa-plus mr-1"></i>Reponer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 3. PR√ìXIMOS A VENCER -->
  <div class="bg-white border-l-4 border-orange-400 rounded-lg shadow-md overflow-hidden">
    <div class="bg-orange-50 px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-bold text-orange-800 flex items-center">
        <i class="fas fa-hourglass-half mr-2 text-orange-500"></i>
        üïê PR√ìXIMOS A VENCER ({{ alertasPorVencer.length }})
        <span class="ml-3 text-sm font-normal text-orange-600">‚Äî Vencen en ‚â§ {{ diasAlertaPorVencer }} d√≠as</span>
      </h3>
    </div>
    <div class="p-4">
      <div *ngIf="alertasPorVencer.length === 0" class="text-center py-6 text-gray-500">
        <i class="fas fa-calendar-check text-green-500 text-3xl mb-2"></i>
        <p>No hay entradas pr√≥ximas a vencer en los pr√≥ximos {{ diasAlertaPorVencer }} d√≠as.</p>
      </div>
      <div *ngIf="alertasPorVencer.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lote</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Vencimiento</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acci√≥n</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let e of alertasPorVencer" class="hover:bg-orange-50">
              <td class="px-4 py-3 font-medium text-gray-900">{{ e.product?.name || 'Producto' }}</td>
              <td class="px-4 py-3 text-sm text-gray-600">{{ e.codigoLote || '-' }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-1 rounded bg-orange-100 text-orange-800 text-sm font-medium">
                  <i class="fas fa-calendar-alt mr-1"></i>
                  {{ e.fechaVencimiento | date:'dd/MM/yyyy' }}
                </span>
              </td>
              <td class="px-4 py-3 text-right font-medium text-gray-900">
                {{ (e.stockBaseRestante || 0) | number:'1.0-2' }}
              </td>
              <td class="px-4 py-3 text-center">
                <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-lg text-sm">
                  <i class="fas fa-clock mr-1"></i>Priorizar uso
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 4. VENCIDOS (No consumibles) -->
  <div class="bg-white border-l-4 border-gray-400 rounded-lg shadow-md overflow-hidden">
    <div class="bg-gray-100 px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-bold text-gray-700 flex items-center">
        <i class="fas fa-ban mr-2 text-gray-500"></i>
        ‚ùå VENCIDOS ({{ alertasVencidas.length }})
        <span class="ml-3 text-sm font-normal text-gray-500">‚Äî No consumibles, considerar dar de baja</span>
      </h3>
    </div>
    <div class="p-4">
      <div *ngIf="alertasVencidas.length === 0" class="text-center py-6 text-gray-500">
        <i class="fas fa-smile text-green-500 text-3xl mb-2"></i>
        <p>No hay entradas vencidas. ¬°Excelente gesti√≥n de inventario!</p>
      </div>
      <div *ngIf="alertasVencidas.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lote</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Vencimiento</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock Perdido</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acci√≥n</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let e of alertasVencidas" class="bg-gray-50 hover:bg-gray-100">
              <td class="px-4 py-3 font-medium text-gray-600 line-through">{{ e.product?.name || 'Producto' }}</td>
              <td class="px-4 py-3 text-sm text-gray-500">{{ e.codigoLote || '-' }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-1 rounded bg-red-100 text-red-700 text-sm">
                  <i class="fas fa-calendar-times mr-1"></i>
                  {{ e.fechaVencimiento | date:'dd/MM/yyyy' }}
                </span>
              </td>
              <td class="px-4 py-3 text-right font-medium text-red-600">
                {{ (e.stockBaseRestante || 0) | number:'1.0-2' }}
              </td>
              <td class="px-4 py-3 text-center">
                <button class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors">
                  <i class="fas fa-trash-alt mr-1"></i>Dar baja
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 5. PETICIONES ATENDIDAS (Historial) -->
  <div class="bg-white border-l-4 border-green-400 rounded-lg shadow-md overflow-hidden">
    <div class="bg-green-50 px-6 py-4 flex justify-between items-center">
      <h3 class="text-lg font-bold text-green-800 flex items-center">
        <i class="fas fa-check-double mr-2 text-green-500"></i>
        ‚úÖ REPOSICIONES RECIENTES ({{ resolvedRechargeRequests.length }})
        <span class="ml-3 text-sm font-normal text-green-600">‚Äî Peticiones atendidas</span>
      </h3>
    </div>
    <div class="p-4">
      <div *ngIf="resolvedRechargeRequests.length === 0" class="text-center py-6 text-gray-500">
        <i class="fas fa-history text-gray-400 text-3xl mb-2"></i>
        <p>No hay reposiciones recientes registradas.</p>
      </div>
      <div *ngIf="resolvedRechargeRequests.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Cantidad Solicitada</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Solicitud</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Estado</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <tr *ngFor="let r of resolvedRechargeRequests" class="hover:bg-green-50">
              <td class="px-4 py-3 font-medium text-gray-900">{{ r.name }}</td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">{{ r.cantidadRequerida | number:'1.0-2' }}</td>
              <td class="px-4 py-3 text-sm text-gray-500">{{ r.requestedAt | date:'dd/MM/yyyy HH:mm' }}</td>
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                  <i class="fas fa-check mr-1"></i>Atendida
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

  <!-- Vista de Productos (existente) -->
  <div *ngIf="vistaActual === 'productos' && !botiquinOnly">
  
  <!-- Indicador de carga -->
  <div *ngIf="isLoading" class="flex justify-center my-4">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
  </div>
  
  <!-- Panel de b√∫squeda/filtros -->
  <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
    <h2 class="text-lg font-medium text-blue-800 mb-3">Filtros de b√∫squeda</h2>
    <form [formGroup]="searchForm" (ngSubmit)="searchProducts()" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="space-y-1">
        <label class="text-sm font-medium text-gray-700">Nombre</label>
        <input type="text" formControlName="name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Buscar por nombre...">
      </div>
      
      <div class="space-y-1">
        <label class="text-sm font-medium text-gray-700">Proveedor</label>
        <select formControlName="providerId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Todos</option>
          <option *ngFor="let provider of providers" [value]="provider.id">{{ provider.name }}</option>
        </select>
      </div>
      
      <div class="space-y-1">
        <label class="text-sm font-medium text-gray-700">Tipo de Alimento</label>
        <select formControlName="typeFoodId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Todos</option>
          <option *ngFor="let typeFood of typeFoods" [value]="typeFood.id">{{ typeFood.name }}</option>
        </select>
      </div>
      
      <div class="space-y-1">
        <label class="text-sm font-medium text-gray-700">Animal</label>
        <select formControlName="animalId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Todos</option>
          <option *ngFor="let animal of animals" [value]="animal.id">{{ animal.name }}</option>
        </select>
      </div>
      
      <div class="space-y-1">
        <label class="text-sm font-medium text-gray-700">Etapa</label>
        <select formControlName="stageId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          <option value="">Todos</option>
          <option *ngFor="let stage of stages" [value]="stage.id">{{ stage.name }}</option>
        </select>
      </div>
      
      <div class="flex items-end space-x-2">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          Buscar
        </button>
        <button type="button" (click)="resetFilters()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
          Limpiar
        </button>
      </div>
    </form>
  </div>
  
  <!-- Panel principal de productos -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-blue-800">Listado de Productos</h2>
      <div class="flex items-center space-x-2">
        <button 
          (click)="actualizarProductosYStock()" 
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition-colors duration-300 shadow-sm flex items-center">
          <i class="fas fa-sync-alt mr-2"></i> Actualizar
        </button>
        <button 
          (click)="sincronizarInventario()" 
          class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg transition-colors duration-300 shadow-sm flex items-center">
          <i class="fas fa-link mr-2"></i> Sincronizar inventario
        </button>
        <button 
          (click)="openForm(false)" 
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-300 shadow-sm flex items-center">
          <span class="mr-1">+</span> Nuevo Producto
        </button>
      </div>
    </div>
    
    <!-- Solicitudes de recarga pendientes -->
    <div *ngIf="pendingRechargeRequests?.length > 0" class="mb-4">
      <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded p-4">
        <div class="flex items-center mb-2">
          <span class="text-yellow-600 mr-2">‚ö°</span>
          <h4 class="text-sm font-semibold text-yellow-800">Solicitudes de recarga pendientes ({{ pendingRechargeRequests.length }})</h4>
        </div>
        <ul class="list-disc pl-6 text-sm text-yellow-900 space-y-1">
          <li *ngFor="let r of pendingRechargeRequests">
            <span class="font-medium">{{ r.name }}</span>
            <span class="opacity-80"> ‚Äî requerido {{ (r.cantidadRequerida || 0) | number:'1.0-2' }} vs disponible {{ (r.cantidadDisponible || 0) | number:'1.0-2' }}</span>
            <span *ngIf="r.loteCodigo" class="opacity-60"> ‚Ä¢ Lote: {{ r.loteCodigo }}</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Solicitudes atendidas (recarga realizada) -->
    <div *ngIf="resolvedRechargeRequests?.length > 0" class="mb-4">
      <div class="bg-green-50 border-l-4 border-green-400 rounded p-4">
        <div class="flex items-center mb-2">
          <span class="text-green-600 mr-2">‚úÖ</span>
          <h4 class="text-sm font-semibold text-green-800">Solicitudes atendidas ({{ resolvedRechargeRequests.length }})</h4>
        </div>
        <ul class="list-disc pl-6 text-sm text-green-900 space-y-1">
          <li *ngFor="let r of resolvedRechargeRequests">
            <span class="font-medium">{{ r.name }}</span>
            <span class="opacity-80"> ‚Äî requerido {{ (r.cantidadRequerida || 0) | number:'1.0-2' }}</span>
            <span *ngIf="r.loteCodigo" class="opacity-60"> ‚Ä¢ Lote: {{ r.loteCodigo }}</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Real</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disminuci√≥n</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Compra</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo Alimento</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Animal</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngIf="filteredProducts.length === 0 && !isLoading" class="hover:bg-gray-50">
            <td colspan="9" class="px-4 py-4 text-center text-sm text-gray-500">No se encontraron productos</td>
          </tr>
          <tr *ngFor="let product of filteredProducts" class="hover:bg-gray-50">
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <div class="flex items-center gap-2">
                <span [ngClass]="{'font-bold': getCantidadRealProducto(product) === 0 || esStockBajo(product)}">{{ product.name }}</span>
                <!-- Badge de stock agotado -->
                <span *ngIf="getCantidadRealProducto(product) === 0"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-red-100 text-red-800 border border-red-400 animate-pulse">
                  ‚õî AGOTADO
                </span>
                <!-- Badge de stock bajo -->
                <span *ngIf="esStockBajo(product) && getCantidadRealProducto(product) > 0"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-orange-100 text-orange-800 border border-orange-300">
                  ‚ö†Ô∏è BAJO
                </span>
                <!-- Badge de solicitud de recarga pendiente -->
                <span *ngIf="hasRechargeRequest(product)" [title]="getRechargeTooltip(product)"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                  üìã Solicitado
                </span>
              </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ getStockTotalProducto(product) | number:'1.0-2' }}</td>
            <!-- Cantidad Real (proporcional por tipo) -->
            <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold" [ngClass]="{'text-green-700': getCantidadRealProducto(product) > 0 && !esStockBajo(product), 'text-orange-600': esStockBajo(product) && getCantidadRealProducto(product) > 0, 'text-red-700': getCantidadRealProducto(product) === 0}">
              <div class="flex items-center gap-2">
                <span>{{ getCantidadRealProducto(product) | number:'1.0-2' }}</span>
                <span *ngIf="hasStockMismatch(product)" [title]="getStockMismatchTooltip(product)" class="text-yellow-600" aria-label="Desfase de stock">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.591c.75 1.333-.213 2.987-1.742 2.987H3.48c-1.53 0-2.492-1.654-1.743-2.987L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-1-2a1 1 0 01-1-1V8a1 1 0 112 0v3a1 1 0 01-1 1z" clip-rule="evenodd" />
                  </svg>
                </span>
              </div>
            </td>
            <!-- Disminuci√≥n real -->
            <td class="px-4 py-3 whitespace-nowrap text-sm text-orange-700 font-semibold">
              {{ getDisminucionProducto(product) | number:'1.0-2' }}
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ product.price_unit | currency:'USD':'symbol':'1.2-2' }}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
              {{ product.date_compra ? (toDate(product.date_compra) | date:'dd/MM/yyyy') : '-' }}
            </td>
            <!-- Tipo de Alimento -->
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
              {{ product.typeFood?.name || getTypeFoodName(product.typeFood_id) }}
            </td>
            <!-- Animal -->
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
              {{ product.animal?.name || getAnimalName(product.animal_id) }}
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
              <div class="flex justify-center items-center space-x-2">
                <!-- Bot√≥n de REPONER prominente para stock agotado -->
                <button *ngIf="getCantidadRealProducto(product) === 0"
                  (click)="reponerProducto(product)" 
                  class="px-3 py-1.5 text-xs font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-md hover:shadow-lg transition-all flex items-center gap-1 animate-pulse"
                  title="‚ö†Ô∏è URGENTE: Reponer stock FEFO">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" />
                  </svg>
                  Reponer Ahora
                </button>
                <!-- Bot√≥n de REPONER para stock bajo (menos urgente) -->
                <button *ngIf="esStockBajo(product) && getCantidadRealProducto(product) > 0"
                  (click)="reponerProducto(product)" 
                  class="px-2 py-1 text-xs font-medium bg-orange-500 text-white rounded hover:bg-orange-600 shadow transition-all flex items-center gap-1"
                  title="Stock bajo - Recomendar reposici√≥n">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
                  </svg>
                  Reponer
                </button>
                <!-- Icono de alerta de solicitud pendiente -->
                <span *ngIf="hasRechargeRequest(product)" [title]="getRechargeTooltip(product)" class="text-yellow-600 animate-bounce" aria-label="Recarga solicitada">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 2a6 6 0 00-6 6v2.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 10.586V8a6 6 0 00-6-6z" />
                    <path d="M10 18a2 2 0 002-2H8a2 2 0 002 2z" />
                  </svg>
                </span>
                <!-- Bot√≥n de editar (solo si no hay alerta cr√≠tica) -->
                <button *ngIf="getCantidadRealProducto(product) > 0 && !esStockBajo(product)"
                  (click)="openForm(true, product)" 
                  class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-100 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button 
                  (click)="deleteProduct(product.id)" 
                  class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Modal de formulario -->
  <div *ngIf="showForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto" cdkDrag>
      <div class="p-6" cdkDragHandle>
        <div class="flex justify-between items-center mb-4 cursor-move">
          <h3 class="text-xl font-semibold text-gray-900">
            <span *ngIf="isEditMode">Editar Producto</span>
            <span *ngIf="!isEditMode">Nuevo Producto</span>
          </h3>
          <button (click)="closeForm()" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form [formGroup]="productForm" (ngSubmit)="saveProduct()" class="space-y-6">
          
          <!-- SECCI√ìN 1: INFORMACI√ìN B√ÅSICA -->
          <div class="bg-white border-l-4 border-purple-500 rounded-lg p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">üìã</span>
              <h3 class="text-lg font-semibold text-purple-700">INFORMACI√ìN B√ÅSICA</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Nombre del Producto -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Nombre del Producto <span class="text-red-500">*</span></label>
                <input type="text" formControlName="name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: Ma√≠z amarillo">
                <div *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Animal -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Animal <span class="text-red-500">*</span></label>
                <select formControlName="animal_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                  <option value="">Seleccione un animal</option>
                  <option *ngFor="let animal of animals" [value]="animal.id">{{ animal.name }}</option>
                </select>
                <div *ngIf="productForm.get('animal_id')?.invalid && productForm.get('animal_id')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Descripci√≥n -->
              <div class="space-y-1 md:col-span-2">
                <label class="text-sm font-medium text-gray-700">Descripci√≥n</label>
                <textarea formControlName="description" rows="3" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Descripci√≥n breve del producto..."></textarea>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN 2: CLASIFICACI√ìN DEL PRODUCTO -->
          <div class="bg-white border-l-4 border-yellow-500 rounded-lg p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">üè∑Ô∏è</span>
              <h3 class="text-lg font-semibold text-yellow-700">CLASIFICACI√ìN DEL PRODUCTO</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Categor√≠a Principal -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Categor√≠a Principal <span class="text-red-500">*</span></label>
                <select formControlName="typeFood_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                  <option value="">Seleccione una categor√≠a</option>
                  <option *ngFor="let typeFood of typeFoods" [value]="typeFood.id">{{ typeFood.name }}</option>
                </select>
                <div *ngIf="productForm.get('typeFood_id')?.invalid && productForm.get('typeFood_id')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>

              <!-- Subcategor√≠a -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Subcategor√≠a <span class="text-red-500">*</span></label>
                <select formControlName="subcategory_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                  <option value="">Primero seleccione una categor√≠a</option>
                  <option *ngFor="let sc of subcategories" [value]="sc.id">{{ sc.name }}</option>
                </select>
                <div *ngIf="subcategoryInfo" class="text-xs text-gray-600 italic mt-1">{{ subcategoryInfo }}</div>
              </div>
              
              <!-- Etapa -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Etapa <span class="text-red-500">*</span></label>
                <select formControlName="stage_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
                  <option value="">Seleccione una etapa</option>
                  <option *ngFor="let stage of stages" [value]="stage.id">{{ stage.name }}</option>
                </select>
                <div *ngIf="productForm.get('stage_id')?.invalid && productForm.get('stage_id')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN 3: CONTROL DE INVENTARIO -->
          <div class="bg-white border-l-4 border-orange-500 rounded-lg p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">üì¶</span>
              <h3 class="text-lg font-semibold text-orange-700">CONTROL DE INVENTARIO</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Unidad de Medida -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Unidad de Medida <span class="text-red-500">*</span></label>
                <select formControlName="unitMeasurement_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                  <option value="">Seleccione una unidad</option>
                  <option *ngFor="let unit of unitMeasurements" [value]="unit.id">{{ unit.name }}</option>
                </select>
                <div *ngIf="productForm.get('unitMeasurement_id')?.invalid && productForm.get('unitMeasurement_id')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Cantidad Actual -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Cantidad Actual <span class="text-red-500">*</span></label>
                <input type="number" formControlName="quantity" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                <div *ngIf="productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Nivel M√≠nimo (Alerta) -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Nivel M√≠nimo (Alerta) <span class="text-red-500">*</span></label>
                <input type="number" step="0.01" formControlName="level_min" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                <div class="flex items-center gap-1 mt-1 text-xs text-orange-600">
                  <span>‚ö†Ô∏è</span>
                  <span>Se alertar√° cuando llegue a este nivel</span>
                </div>
              </div>
              
              <!-- Nivel M√°ximo -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Nivel M√°ximo</label>
                <input type="number" step="0.01" formControlName="level_max" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="0">
                <div class="text-xs text-gray-500 mt-1">Capacidad m√°xima de almacenamiento</div>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN 4: INFORMACI√ìN DE COMPRA -->
          <div class="bg-white border-l-4 border-green-600 rounded-lg p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">üí∞</span>
              <h3 class="text-lg font-semibold text-green-700">INFORMACI√ìN DE COMPRA</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Precio Unitario -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Precio Unitario <span class="text-red-500">*</span></label>
                <input type="number" step="0.01" formControlName="price_unit" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="0.00">
                <div *ngIf="productForm.get('price_unit')?.invalid && productForm.get('price_unit')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Proveedor -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Proveedor <span class="text-red-500">*</span></label>
                <select formControlName="provider_id" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="">Seleccione un proveedor</option>
                  <option *ngFor="let provider of providers" [value]="provider.id">{{ provider.name }}</option>
                </select>
                <div *ngIf="productForm.get('provider_id')?.invalid && productForm.get('provider_id')?.touched" class="text-sm text-red-600">
                  Este campo es requerido
                </div>
              </div>
              
              <!-- Fecha de Compra -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Fecha de Compra <span class="text-red-500">*</span></label>
                <input type="date" formControlName="date_compra" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              
              <!-- N√∫mero de Factura -->
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">N√∫mero de Factura</label>
                <input type="text" formControlName="number_facture" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="FAC-12345">
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n espec√≠fica para Medicamentos -->
          <div *ngIf="showMedicamentos" class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-600 space-y-4">
            <div class="text-purple-700 font-semibold flex items-center gap-2">
              <span class="text-xl">üíä</span>
              <span>Datos de Medicamento</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Uso Principal *</label>
                <input type="text" formControlName="usoPrincipal" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: Infecciones respiratorias">
              </div>
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Dosis Recomendada *</label>
                <input type="text" formControlName="dosisRecomendada" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Ej: 1 ml/10 kg">
              </div>
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">V√≠a de Administraci√≥n *</label>
                <select formControlName="viaAdministracion" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                  <option value="">Seleccione una v√≠a</option>
                  <option value="im">Intramuscular (IM)</option>
                  <option value="iv">Intravenosa (IV)</option>
                  <option value="sc">Subcut√°nea (SC)</option>
                  <option value="oral">Oral</option>
                  <option value="topica">T√≥pica</option>
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Tiempo de Retiro (d√≠as) *</label>
                <input type="number" formControlName="tiempoRetiro" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" min="0">
              </div>
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Fecha de Vencimiento *</label>
                <input type="date" formControlName="fechaVencimiento" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
              </div>
              <div class="space-y-1 md:col-span-2">
                <label class="text-sm font-medium text-gray-700">Observaciones M√©dicas</label>
                <textarea rows="2" formControlName="observacionesMedicas" class="w-full p-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" placeholder="Notas u observaciones..."></textarea>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="incluirEnBotiquin" formControlName="incluirEnBotiquin" class="w-5 h-5 text-green-600 border-2 border-gray-300 rounded focus:ring-2 focus:ring-green-500 cursor-pointer">
              <label for="incluirEnBotiquin" class="text-sm font-medium text-gray-800 cursor-pointer">Incluir en Botiqu√≠n</label>
            </div>
          </div>

          <!-- Secci√≥n espec√≠fica para Alimentos (opcional) -->
          <div *ngIf="showAlimentos" class="p-4 bg-green-50 rounded-lg border-l-4 border-green-600 space-y-4">
            <div class="text-green-700 font-semibold flex items-center gap-2">
              <span class="text-xl">üåæ</span>
              <span>Informaci√≥n Nutricional</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Presentaci√≥n</label>
                <select formControlName="presentacion" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                  <option value="">Seleccione</option>
                  <option value="entero">Entero</option>
                  <option value="molido">Molido</option>
                  <option value="picado">Picado</option>
                  <option value="liquido">L√≠quido</option>
                  <option value="pellet">Pellet</option>
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-sm font-medium text-gray-700">Informaci√≥n Nutricional</label>
                <input type="text" formControlName="infoNutricional" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="Ej: Prote√≠na 18%, Grasa 4%">
              </div>
            </div>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
            <button type="button" (click)="closeForm()" class="px-6 py-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors font-medium shadow-md">
              Cancelar
            </button>
            <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-md flex items-center gap-2">
              <span>üíæ</span>
              <span>Guardar Producto</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>


</div> <!-- Fin de la vista de productos -->

<!-- Vista de Entradas -->
<div *ngIf="vistaActual === 'entradas' && !botiquinOnly">
  <div class="space-y-6">
    
    <!-- CABECERA: T√≠tulo + Bot√≥n Nueva Entrada -->
    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-inbox mr-2 text-blue-600"></i>Gesti√≥n de Entradas
          </h2>
          <p class="text-sm text-gray-500 mt-1">Administra todas las entradas de inventario por producto</p>
        </div>
        <button *ngIf="!mostrarFormularioEntrada"
                (click)="abrirFormularioNuevaEntrada()"
                class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all shadow-md flex items-center gap-2 font-semibold">
          <i class="fas fa-plus-circle"></i>
          Nueva Entrada
        </button>
        <button *ngIf="mostrarFormularioEntrada"
                (click)="cerrarFormularioEntrada()"
                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all shadow-md flex items-center gap-2 font-semibold">
          <i class="fas fa-times"></i>
          Cerrar Formulario
        </button>
      </div>

      <!-- Buscador de entradas -->
      <div class="flex items-center gap-4" *ngIf="!mostrarFormularioEntrada">
        <div class="flex-1">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" [(ngModel)]="filtroProductoEntradas" 
                   placeholder="Buscar por producto o c√≥digo de lote..."
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <button (click)="cargarTodasLasEntradas()" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
          <i class="fas fa-sync-alt mr-1"></i> Actualizar
        </button>
      </div>
    </div>

    <!-- TARJETAS KPI: Costo Total por Producto -->
    <div *ngIf="!mostrarFormularioEntrada" class="bg-gradient-to-r from-gray-50 to-blue-50 border border-gray-200 rounded-lg p-4 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">
          <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>Inversi√≥n por Producto
        </h3>
        <div class="text-right">
          <span class="text-xs text-gray-500 uppercase">Total Invertido</span>
          <p class="text-xl font-bold text-indigo-700">${{ getTotalInvertidoGeneral() | number:'1.2-2' }}</p>
        </div>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
        <div *ngFor="let producto of getProductosConEntradas()" 
             class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
              <h4 class="text-sm font-semibold text-gray-800 truncate" [title]="producto.name">
                {{ producto.name }}
              </h4>
              <p class="text-xs text-gray-500">{{ producto.typeFood?.name || 'General' }}</p>
            </div>
            <div class="flex-shrink-0 ml-2">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full"
                    [ngClass]="getCostoTotalProducto(producto.id!) > 0 ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'">
                <i class="fas fa-dollar-sign text-sm"></i>
              </span>
            </div>
          </div>
          <div class="mt-2 pt-2 border-t border-gray-100">
            <!-- Costo Total (Compra Inicial + Entradas) -->
            <div class="flex items-baseline justify-between">
              <span class="text-xs text-gray-500">Inversi√≥n Total:</span>
              <span class="text-lg font-bold" 
                    [ngClass]="getCostoTotalProducto(producto.id!) > 0 ? 'text-green-600' : 'text-gray-400'">
                ${{ getCostoTotalProducto(producto.id!) | number:'1.2-2' }}
              </span>
            </div>
            <!-- Desglose: Compra inicial -->
            <div *ngIf="getCostoInicialProducto(producto) > 0" class="flex items-baseline justify-between mt-1">
              <span class="text-xs text-gray-400">
                <i class="fas fa-shopping-cart mr-1"></i>Compra inicial:
              </span>
              <span class="text-xs text-gray-500">${{ getCostoInicialProducto(producto) | number:'1.2-2' }}</span>
            </div>
            <!-- Desglose: Entradas/Recargas -->
            <div class="flex items-baseline justify-between mt-1">
              <span class="text-xs text-gray-500">
                <i class="fas fa-inbox mr-1"></i>Recargas:
              </span>
              <span class="text-sm font-medium text-blue-600">{{ getConteoEntradasProducto(producto.id!) }}</span>
            </div>
          </div>
        </div>
        
        <!-- Mensaje si no hay productos con entradas -->
        <div *ngIf="getProductosConEntradas().length === 0" 
             class="col-span-full text-center py-8 text-gray-400">
          <i class="fas fa-box-open text-3xl mb-2"></i>
          <p class="text-sm">No hay productos con entradas registradas</p>
        </div>
      </div>
    </div>

    <!-- FORMULARIO DE NUEVA ENTRADA (oculto por defecto) -->
    <div *ngIf="mostrarFormularioEntrada" class="bg-white border border-blue-200 rounded-lg p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-blue-800 mb-4">
        <i class="fas fa-plus-circle mr-2"></i>Registrar Nueva Entrada
      </h3>
      
      <!-- Nota explicativa -->
      <div class="mb-4 p-3 rounded-md border border-blue-200 bg-blue-50 text-blue-800 text-sm">
        <div class="flex items-start">
          <i class="fas fa-info-circle mt-0.5 mr-2"></i>
          <div>
            <p class="font-semibold">Unidad de control vs Unidad base</p>
            <p>La <strong>Unidad de control</strong> es el empaque (saco, frasco, caja). Los c√°lculos se hacen en <strong>unidad base</strong> (kg, g, ml).</p>
          </div>
        </div>
      </div>
      <!-- Alerta cuando el producto est√° bloqueado (modo Reponer) -->
      <div *ngIf="productoEntradasBloqueado && selectedProductIdEntradas" class="mb-4 p-4 rounded-lg bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 shadow-sm">
        <div class="flex items-start">
          <div class="flex-shrink-0 bg-blue-100 rounded-full p-2 mr-3">
            <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-blue-900 text-lg mb-1">
              <i class="fas fa-box-open mr-2"></i>Modo Reposici√≥n Activo
            </h3>
            <p class="text-sm text-blue-800 mb-2">
              Registrando entrada para: 
              <strong class="font-bold text-blue-900">{{ getProductoById(selectedProductIdEntradas)?.name || 'Producto seleccionado' }}</strong>
            </p>
            
            <!-- Informaci√≥n de stock y cantidad sugerida -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 bg-white/50 rounded-lg p-3">
              <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Stock Actual</p>
                <p class="text-lg font-bold text-red-600">
                  {{ getCantidadRealProducto(getProductoById(selectedProductIdEntradas)!) | number:'1.0-2' }}
                  <span class="text-xs font-normal">{{ getProductoById(selectedProductIdEntradas)?.unitMeasurement?.name || 'kg' }}</span>
                </p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500 uppercase">Stock M√≠nimo</p>
                <p class="text-lg font-bold text-purple-600">
                  {{ getProductoById(selectedProductIdEntradas)?.level_min || 0 | number:'1.0-2' }}
                  <span class="text-xs font-normal">{{ getProductoById(selectedProductIdEntradas)?.unitMeasurement?.name || 'kg' }}</span>
                </p>
              </div>
              <div class="text-center bg-green-50 rounded-lg p-2 border border-green-200">
                <p class="text-xs text-green-600 uppercase font-semibold">üí° Sugerido a Reponer</p>
                <p class="text-xl font-bold text-green-700">
                  {{ getCantidadSugerida(getProductoById(selectedProductIdEntradas)!) | number:'1.0-2' }}
                  <span class="text-xs font-normal">{{ getProductoById(selectedProductIdEntradas)?.unitMeasurement?.name || 'kg' }}</span>
                </p>
              </div>
            </div>
            
            <p class="text-xs text-blue-600 mt-2 italic">
              <i class="fas fa-info-circle mr-1"></i>
              La cantidad sugerida llevar√° el stock al 150% del nivel m√≠nimo configurado.
            </p>
          </div>
          <button (click)="productoEntradasBloqueado = false" 
                  class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium transition-colors ml-3"
                  title="Cambiar producto">
            <i class="fas fa-exchange-alt mr-1"></i>Cambiar
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="text-sm font-medium text-gray-700">Producto</label>
          <select #productoEntrada class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                  [class.bg-gray-100]="productoEntradasBloqueado"
                  [class.cursor-not-allowed]="productoEntradasBloqueado"
                  [disabled]="productoEntradasBloqueado"
                  name="productoEntrada" (change)="onProductoEntradasChange(productoEntrada.value)">
            <option value="">Seleccione un producto</option>
            <option *ngFor="let p of products" [value]="p.id" [selected]="p.id === selectedProductIdEntradas">{{ p.name }}</option>
          </select>
          <p *ngIf="productoEntradasBloqueado" class="text-xs text-gray-500 mt-1">
            üîí Producto bloqueado para reposici√≥n
          </p>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Unidad de control</label>
          <input type="text" list="unidadesControlLista" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" [formControl]="entradaForm.controls['unidadControl']" placeholder="Ej.: saco, frasco, caja">
          <datalist id="unidadesControlLista">
            <option value="saco"></option>
            <option value="bolsa"></option>
            <option value="caja"></option>
            <option value="frasco"></option>
            <option value="sobre"></option>
            <option value="bid√≥n"></option>
            <option value="balde"></option>
            <option value="gal√≥n"></option>
            <option value="quintal"></option>
            <option value="unidad"></option>
          </datalist>
        </div>
        <div class="flex items-end">
          <button (click)="onProductoEntradasChange(productoEntrada.value || ''); productoEntradasBloqueado = false" 
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
            Refrescar
          </button>
        </div>
      </div>

      <!-- Resumen del inventario del producto seleccionado (por producto) -->
      <div *ngIf="invProductoSeleccionado" class="mb-4 p-4 border rounded-lg bg-gray-50">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-base font-semibold text-gray-800">{{ invProductoSeleccionado.product?.name }}</h3>
            <p class="text-sm text-gray-600">Unidad base: {{ invProductoSeleccionado.unidadMedida || getUnidadBaseProducto(selectedProductIdEntradas) }}</p>
          </div>
          <div>
            <span class="px-2 py-1 rounded text-xs font-medium"
                  [ngClass]="(invProductoSeleccionado.cantidadStock || 0) <= (invProductoSeleccionado.stockMinimo || 0) ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'">
              {{ (invProductoSeleccionado.cantidadStock || 0) <= (invProductoSeleccionado.stockMinimo || 0) ? 'CR√çTICO' : 'OK' }}
            </span>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-3">
          <div class="p-3 bg-white rounded border">
            <p class="text-xs text-gray-500">Stock actual</p>
            <p class="text-lg font-semibold">{{ (invProductoSeleccionado.cantidadStock || 0) | number:'1.0-2' }} {{ invProductoSeleccionado.unidadMedida }}</p>
          </div>
          <div class="p-3 bg-white rounded border">
            <p class="text-xs text-gray-500">Stock m√≠nimo</p>
            <p class="text-lg">{{ getStockMinimoProductoSeleccionado() | number:'1.0-2' }} {{ invProductoSeleccionado.unidadMedida || getUnidadBaseProducto(selectedProductIdEntradas) }}</p>
          </div>
          <div class="p-3 bg-white rounded border">
            <p class="text-xs text-gray-500">Costo unitario promedio</p>
            <p class="text-lg">{{ (invProductoSeleccionado.costoUnitarioPromedio || 0) | number:'1.2-4' }}</p>
          </div>
          <div class="p-3 bg-white rounded border">
            <p class="text-xs text-gray-500">Actualizado</p>
            <p class="text-lg">{{ invProductoSeleccionado.updateDate ? (toDate(invProductoSeleccionado.updateDate) | date:'dd/MM/yyyy') : '-' }}</p>
          </div>
        </div>
      </div>

      <form [formGroup]="entradaForm" (ngSubmit)="crearEntrada()" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="hidden" formControlName="productId">
        <div>
          <label class="text-sm font-medium text-gray-700">Contenido por unidad (base)
            <span class="text-gray-500">[{{ getUnidadBaseProducto(selectedProductIdEntradas) }}]</span>
          </label>
          <input type="number" step="0.001" formControlName="contenidoPorUnidadBase" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="ej: 50 (ml) o 1 (kg)">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Cantidad de unidades</label>
          <input type="number" step="0.001" formControlName="cantidadUnidades" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">C√≥digo de lote</label>
          <input type="text" formControlName="codigoLote" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="md:col-span-3 text-sm text-gray-600">
          Total base calculado: 
          <span class="font-semibold">{{ getTotalBaseCalculado() | number:'1.0-3' }} {{ getUnidadBaseProducto(selectedProductIdEntradas) }}</span>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Fecha ingreso</label>
          <input type="date" formControlName="fechaIngreso" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Fecha vencimiento</label>
          <input type="date" formControlName="fechaVencimiento" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Observaciones</label>
          <input type="text" formControlName="observaciones" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Proveedor</label>
          <select formControlName="providerId" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            <option value="">Seleccione un proveedor</option>
            <option *ngFor="let prov of providers" [value]="prov.id">{{ prov.name }}</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Costo unitario (base)</label>
          <input type="number" step="0.0001" formControlName="costoUnitarioBase" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="ej: costo por kg/ml">
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Costo por unidad de control</label>
          <input type="number" step="0.0001" formControlName="costoPorUnidadControl" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="opcional: costo por saco/frasco">
        </div>
        <div class="md:col-span-3 flex justify-end gap-3">
          <button type="button" (click)="cerrarFormularioEntrada()" 
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
            Cancelar
          </button>
          <button type="submit" [disabled]="entradaForm.invalid || !selectedProductIdEntradas" 
                  class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
            <i class="fas fa-save mr-1"></i> Crear Entrada
          </button>
        </div>
      </form>
    </div>

    <!-- LISTADO PRINCIPAL DE TODAS LAS ENTRADAS -->
    <div *ngIf="!mostrarFormularioEntrada" class="bg-white border border-gray-200 rounded-lg shadow-sm">
      <div class="p-4 border-b border-gray-200 bg-gray-50">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <h3 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-list mr-2 text-blue-600"></i>Listado de Entradas
          </h3>
          
          <!-- Toggle Vigentes / Hist√≥rico / Todos -->
          <div class="flex items-center gap-2">
            <div class="inline-flex rounded-lg border border-gray-300 bg-gray-100 p-1">
              <button (click)="filtroEstadoEntradas = 'vigentes'" 
                      class="px-4 py-1.5 text-sm font-medium rounded-md transition-all"
                      [ngClass]="filtroEstadoEntradas === 'vigentes' 
                        ? 'bg-green-600 text-white shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-200'">
                <i class="fas fa-check-circle mr-1"></i>Vigentes
                <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full"
                      [ngClass]="filtroEstadoEntradas === 'vigentes' ? 'bg-green-500' : 'bg-gray-300 text-gray-600'">
                  {{ getConteoEntradasVigentes() }}
                </span>
              </button>
              <button (click)="filtroEstadoEntradas = 'finalizados'" 
                      class="px-4 py-1.5 text-sm font-medium rounded-md transition-all"
                      [ngClass]="filtroEstadoEntradas === 'finalizados' 
                        ? 'bg-gray-600 text-white shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-200'">
                <i class="fas fa-history mr-1"></i>Hist√≥rico
                <span class="ml-1 px-1.5 py-0.5 text-xs rounded-full"
                      [ngClass]="filtroEstadoEntradas === 'finalizados' ? 'bg-gray-500' : 'bg-gray-300 text-gray-600'">
                  {{ getConteoEntradasFinalizadas() }}
                </span>
              </button>
              <button (click)="filtroEstadoEntradas = 'todos'" 
                      class="px-4 py-1.5 text-sm font-medium rounded-md transition-all"
                      [ngClass]="filtroEstadoEntradas === 'todos' 
                        ? 'bg-blue-600 text-white shadow-sm' 
                        : 'text-gray-600 hover:bg-gray-200'">
                <i class="fas fa-list-alt mr-1"></i>Todos
              </button>
            </div>
            <span class="text-sm text-gray-500">{{ getEntradasFiltradas().length }} entradas</span>
          </div>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingreso</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vence</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Restante</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let e of getEntradasFiltradas()" class="hover:bg-gray-50">
              <td class="px-4 py-3">
                <div class="font-medium text-gray-900">{{ e.product?.name || 'Sin producto' }}</div>
                <div class="text-xs text-gray-500">{{ e.product?.unitMeasurement?.name || 'kg' }}</div>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600">{{ e.codigoLote || '-' }}</td>
              <td class="px-4 py-3 text-sm text-gray-600">{{ e.fechaIngreso ? (toDate(e.fechaIngreso) | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="px-4 py-3">
                <span *ngIf="e.fechaVencimiento" 
                      [ngClass]="esVencida(e) ? 'text-red-600 font-semibold' : (esPorVencer(e) ? 'text-orange-600' : 'text-gray-600')"
                      class="text-sm">
                  {{ toDate(e.fechaVencimiento) | date:'dd/MM/yyyy' }}
                  <i *ngIf="esVencida(e)" class="fas fa-exclamation-circle ml-1"></i>
                  <i *ngIf="esPorVencer(e) && !esVencida(e)" class="fas fa-clock ml-1"></i>
                </span>
                <span *ngIf="!e.fechaVencimiento" class="text-sm text-gray-400">Sin venc.</span>
              </td>
              <td class="px-4 py-3 text-right">
                <span class="font-semibold" [ngClass]="(e.stockBaseRestante || 0) <= 0 ? 'text-red-600' : 'text-green-600'">
                  {{ (e.stockBaseRestante || 0) | number:'1.0-2' }}
                </span>
                <span class="text-xs text-gray-500 ml-1">{{ e.product?.unitMeasurement?.name || 'kg' }}</span>
              </td>
              <td class="px-4 py-3 text-right">
                <span *ngIf="getCostoEntrada(e) > 0" class="font-semibold text-green-600">
                  ${{ getCostoEntrada(e) | number:'1.2-2' }}
                </span>
                <span *ngIf="getCostoEntrada(e) <= 0" class="text-gray-400 text-sm">-</span>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600">{{ e.provider?.name || '-' }}</td>
              <td class="px-4 py-3 text-center">
                <!-- Estado: Vigente o Finalizado -->
                <span *ngIf="esEntradaVigente(e)" 
                      class="px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 inline-flex items-center">
                  <i class="fas fa-check-circle mr-1"></i>Vigente
                </span>
                <span *ngIf="!esEntradaVigente(e)" 
                      class="px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-600 inline-flex items-center">
                  <i class="fas fa-archive mr-1"></i>Finalizado
                </span>
              </td>
              <td class="px-4 py-3 text-center">
                <!-- Acciones seg√∫n estado -->
                <div *ngIf="esEntradaVigente(e)" class="flex justify-center space-x-1">
                  <!-- Reponer: solo para entradas vigentes -->
                  <button (click)="abrirFormularioNuevaEntrada(e.product)" 
                          class="text-green-600 hover:text-green-800 p-1.5 rounded hover:bg-green-50" 
                          title="Reponer este producto">
                    <i class="fas fa-plus-circle"></i>
                  </button>
                  
                  <!-- Editar: solo para la √∫ltima entrada vigente del producto -->
                  <button *ngIf="esUltimaEntradaDelProducto(e)"
                          (click)="openEditEntrada(e)" 
                          class="text-blue-600 hover:text-blue-800 p-1.5 rounded hover:bg-blue-50" 
                          title="Editar entrada (√∫ltima recarga)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <span *ngIf="!esUltimaEntradaDelProducto(e)"
                        class="text-gray-300 p-1.5 cursor-not-allowed" 
                        title="Solo se puede editar la √∫ltima entrada">
                    <i class="fas fa-lock text-xs"></i>
                  </span>
                  
                  <!-- Eliminar: solo para la √∫ltima entrada vigente del producto -->
                  <button *ngIf="esUltimaEntradaDelProducto(e)"
                          (click)="eliminarEntrada(e)" 
                          class="text-red-600 hover:text-red-800 p-1.5 rounded hover:bg-red-50" 
                          title="Eliminar entrada (√∫ltima recarga)">
                    <i class="fas fa-trash"></i>
                  </button>
                  <span *ngIf="!esUltimaEntradaDelProducto(e)"
                        class="text-gray-300 p-1.5 cursor-not-allowed" 
                        title="Hist√≥rico - No editable">
                    <i class="fas fa-history text-xs"></i>
                  </span>
                </div>
                
                <!-- Para entradas FINALIZADAS: solo ver detalles -->
                <div *ngIf="!esEntradaVigente(e)" class="flex justify-center items-center gap-1 text-gray-400">
                  <i class="fas fa-lock text-xs"></i>
                  <span class="text-xs">Hist√≥rico</span>
                </div>
              </td>
            </tr>
            <tr *ngIf="getEntradasFiltradas().length === 0">
              <td colspan="9" class="px-4 py-8 text-center">
                <div class="text-gray-400">
                  <i class="fas fa-inbox text-4xl mb-2"></i>
                  <p class="text-sm">No hay entradas registradas</p>
                  <button (click)="abrirFormularioNuevaEntrada()" 
                          class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                    <i class="fas fa-plus-circle mr-1"></i> Crear Primera Entrada
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal edici√≥n de entrada -->
<div *ngIf="showEditEntradaModal && !botiquinOnly" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Editar Entrada</h3>
        <button (click)="closeEditEntrada()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form [formGroup]="editEntradaForm" (ngSubmit)="saveEditEntrada()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-gray-700">C√≥digo de lote</label>
          <input type="text" formControlName="codigoLote" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Unidad de control</label>
          <input type="text" formControlName="unidadControl" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Fecha ingreso</label>
          <input type="date" formControlName="fechaIngreso" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Fecha vencimiento</label>
          <input type="date" formControlName="fechaVencimiento" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Contenido por unidad (base)
            <span class="text-gray-500">[{{ getUnidadBaseProducto(selectedProductIdEntradas) }}]</span>
          </label>
          <input type="number" step="0.001" formControlName="contenidoPorUnidadBase" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Cantidad de unidades</label>
          <input type="number" step="0.001" formControlName="cantidadUnidades" class="w-full p-2 border rounded-md" />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium text-gray-700">Observaciones</label>
          <input type="text" formControlName="observaciones" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Proveedor</label>
          <select formControlName="providerId" class="w-full p-2 border rounded-md">
            <option value="">Sin proveedor</option>
            <option *ngFor="let prov of providers" [value]="prov.id">{{ prov.name }}</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Costo unitario (base)</label>
          <input type="number" step="0.0001" formControlName="costoUnitarioBase" class="w-full p-2 border rounded-md" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Costo por unidad de control</label>
          <input type="number" step="0.0001" formControlName="costoPorUnidadControl" class="w-full p-2 border rounded-md" />
        </div>
        <div class="md:col-span-2 flex justify-end space-x-3 mt-2">
          <button type="button" (click)="closeEditEntrada()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Vista de STOCK REAL - Datos FEFO en tiempo real -->
<div *ngIf="vistaActual === 'stock-real' && !botiquinOnly">
  <div class="space-y-6">
    <!-- T√≠tulo de la secci√≥n -->
    <div class="text-center">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">
        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
        Stock Real por Producto (FEFO)
      </h2>
      <p class="text-gray-600">
        Control en tiempo real del stock disponible calculado desde entradas vigentes (no vencidas)
      </p>
    </div>

    <!-- Resumen de Stock con KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Total Productos -->
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-5 shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100 text-sm font-medium">Total Productos</p>
            <p class="text-3xl font-bold">{{ products.length }}</p>
          </div>
          <div class="p-3 bg-blue-400 rounded-full">
            <i class="fas fa-boxes text-white text-xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Stock Normal -->
      <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-5 shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-100 text-sm font-medium">Stock Normal</p>
            <p class="text-3xl font-bold">{{ products.length - productosAgotados.length - productosCriticos.length }}</p>
          </div>
          <div class="p-3 bg-green-400 rounded-full">
            <i class="fas fa-check-circle text-white text-xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Stock Cr√≠tico -->
      <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-5 shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-yellow-100 text-sm font-medium">Stock Cr√≠tico</p>
            <p class="text-3xl font-bold">{{ productosCriticos.length }}</p>
          </div>
          <div class="p-3 bg-yellow-400 rounded-full">
            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
          </div>
        </div>
      </div>
      
      <!-- Agotados -->
      <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg p-5 shadow-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-red-100 text-sm font-medium">Agotados</p>
            <p class="text-3xl font-bold">{{ productosAgotados.length }}</p>
          </div>
          <div class="p-3 bg-red-400 rounded-full">
            <i class="fas fa-times-circle text-white text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas de Productos Agotados -->
    <div *ngIf="productosAgotados.length > 0" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg shadow-sm">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-exclamation-circle text-red-500 text-xl animate-pulse"></i>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-lg font-medium text-red-800">
            ‚õî Productos AGOTADOS ({{ productosAgotados.length }}) - Requieren reposici√≥n inmediata
          </h3>
          <div class="mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            <div *ngFor="let p of productosAgotados" class="flex items-center justify-between bg-white p-2 rounded border border-red-200">
              <span class="text-sm font-medium text-red-800">{{ p.name }}</span>
              <button 
                (click)="reponerProducto(p)" 
                class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors">
                <i class="fas fa-plus mr-1"></i>Reponer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertas de Stock Cr√≠tico -->
    <div *ngIf="productosCriticos.length > 0" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg shadow-sm">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
        </div>
        <div class="ml-3 flex-1">
          <h3 class="text-lg font-medium text-yellow-800">
            ‚ö†Ô∏è Stock CR√çTICO ({{ productosCriticos.length }}) - Por debajo del m√≠nimo
          </h3>
          <div class="mt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            <div *ngFor="let p of productosCriticos" class="flex items-center justify-between bg-white p-2 rounded border border-yellow-200">
              <div>
                <span class="text-sm font-medium text-yellow-800">{{ p.name }}</span>
                <span class="text-xs text-yellow-600 ml-2">
                  ({{ getCantidadRealProducto(p) | number:'1.0-2' }} / {{ p.level_min }} {{ p.unitMeasurement?.name || 'kg' }})
                </span>
              </div>
              <button 
                (click)="reponerProducto(p)" 
                class="px-3 py-1 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition-colors">
                <i class="fas fa-plus mr-1"></i>Reponer
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Stock Real por Producto (FEFO) -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
        <div>
          <h3 class="text-lg font-semibold text-gray-800">
            <i class="fas fa-table text-blue-600 mr-2"></i>
            Detalle de Stock por Producto
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            Stock calculado desde entradas FEFO vigentes (no vencidas). Se actualiza autom√°ticamente.
          </p>
        </div>
        <button 
          (click)="cargarStockReal()" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          <i class="fas fa-sync-alt mr-2"></i>Actualizar
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Disponible</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Vencido</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Consumido</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stock M√≠nimo</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Progreso</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <ng-container *ngFor="let p of products; trackBy: trackByProductId">
            <tr class="hover:bg-gray-50 transition-colors"
                [ngClass]="{'bg-red-50': getEstadoStockProducto(p) === 'AGOTADO', 'bg-yellow-50': getEstadoStockProducto(p) === 'BAJO'}">
              <!-- Producto -->
              <td class="px-4 py-3">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-9 w-9">
                    <div class="h-9 w-9 rounded-full flex items-center justify-center"
                         [ngClass]="{
                           'bg-red-100': getEstadoStockProducto(p) === 'AGOTADO',
                           'bg-yellow-100': getEstadoStockProducto(p) === 'BAJO',
                           'bg-green-100': getEstadoStockProducto(p) === 'NORMAL'
                         }">
                      <i class="fas fa-cube" [ngClass]="{
                           'text-red-600': getEstadoStockProducto(p) === 'AGOTADO',
                           'text-yellow-600': getEstadoStockProducto(p) === 'BAJO',
                           'text-green-600': getEstadoStockProducto(p) === 'NORMAL'
                         }"></i>
                    </div>
                  </div>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">{{ p.name }}</div>
                    <div class="text-xs text-gray-500">
                      {{ p.typeFood?.name || 'Sin tipo' }} ‚Ä¢ {{ p.animal?.name || 'General' }}
                    </div>
                  </div>
                </div>
              </td>
              
              <!-- Stock Disponible -->
              <td class="px-4 py-3 text-right">
                <span class="font-bold text-lg" [ngClass]="{
                  'text-red-600': getEstadoStockProducto(p) === 'AGOTADO',
                  'text-yellow-600': getEstadoStockProducto(p) === 'BAJO',
                  'text-green-600': getEstadoStockProducto(p) === 'NORMAL'
                }">
                  {{ getCantidadRealProducto(p) | number:'1.0-2' }}
                </span>
                <span class="text-xs text-gray-500 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              
              <!-- Stock Vencido -->
              <td class="px-4 py-3 text-right">
                <span class="text-sm" [ngClass]="getVencidoProducto(p) > 0 ? 'text-red-600 font-semibold' : 'text-gray-400'">
                  {{ getVencidoProducto(p) | number:'1.0-2' }}
                </span>
                <span class="text-xs text-gray-400 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              
              <!-- Consumido -->
              <td class="px-4 py-3 text-right">
                <span class="text-sm text-orange-600 font-medium">
                  {{ getDisminucionProducto(p) | number:'1.0-2' }}
                </span>
                <span class="text-xs text-gray-400 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              
              <!-- Stock M√≠nimo -->
              <td class="px-4 py-3 text-right">
                <span class="text-sm text-purple-600">
                  {{ p.level_min || 0 | number:'1.0-2' }}
                </span>
                <span class="text-xs text-gray-400 ml-1">{{ p.unitMeasurement?.name || 'kg' }}</span>
              </td>
              
              <!-- Estado -->
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold"
                      [ngClass]="{
                        'bg-red-100 text-red-800': getEstadoStockProducto(p) === 'AGOTADO',
                        'bg-yellow-100 text-yellow-800': getEstadoStockProducto(p) === 'BAJO',
                        'bg-green-100 text-green-800': getEstadoStockProducto(p) === 'NORMAL'
                      }">
                  <i class="mr-1" [ngClass]="{
                    'fas fa-times-circle': getEstadoStockProducto(p) === 'AGOTADO',
                    'fas fa-exclamation-triangle': getEstadoStockProducto(p) === 'BAJO',
                    'fas fa-check-circle': getEstadoStockProducto(p) === 'NORMAL'
                  }"></i>
                  {{ getEstadoStockProducto(p) }}
                </span>
              </td>
              
              <!-- Progreso -->
              <td class="px-4 py-3">
                <div class="w-20 mx-auto">
                  <div class="bg-gray-200 rounded-full h-2">
                    <div class="h-2 rounded-full transition-all duration-300"
                         [ngClass]="{
                           'bg-red-500': getEstadoStockProducto(p) === 'AGOTADO',
                           'bg-yellow-500': getEstadoStockProducto(p) === 'BAJO',
                           'bg-green-500': getEstadoStockProducto(p) === 'NORMAL'
                         }"
                         [style.width]="getPorcentajeStockProducto(p) + '%'">
                    </div>
                  </div>
                  <div class="text-xs text-gray-500 text-center mt-1">{{ getPorcentajeStockProducto(p) }}%</div>
                </div>
              </td>
              
              <!-- Acciones -->
              <td class="px-4 py-3 text-center">
                <div class="flex justify-center space-x-1">
                  <button 
                    (click)="reponerProducto(p)" 
                    class="p-1.5 rounded transition-colors"
                    [ngClass]="{
                      'bg-red-600 text-white hover:bg-red-700': getEstadoStockProducto(p) === 'AGOTADO',
                      'bg-yellow-500 text-white hover:bg-yellow-600': getEstadoStockProducto(p) === 'BAJO',
                      'bg-gray-200 text-gray-600 hover:bg-gray-300': getEstadoStockProducto(p) === 'NORMAL'
                    }"
                    title="Reponer stock">
                    <i class="fas fa-plus text-sm"></i>
                  </button>
                  <button 
                    (click)="toggleEntradasForProduct(p.id!)" 
                    class="p-1.5 rounded transition-colors"
                    [ngClass]="isEntradasExpanded(p.id!) ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-600 hover:bg-blue-200'"
                    title="Ver entradas">
                    <i class="fas" [ngClass]="isEntradasExpanded(p.id!) ? 'fa-chevron-up' : 'fa-list'" class="text-sm"></i>
                  </button>
                </div>
              </td>
            </tr>
            
            <!-- Fila expandible para mostrar entradas del producto -->
            <tr *ngIf="isEntradasExpanded(p.id!)" class="bg-blue-50">
              <td colspan="8" class="px-4 py-4">
                <div class="bg-white rounded-lg border border-blue-200 p-4">
                  <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                    <i class="fas fa-list mr-2"></i>
                    Entradas de {{ p.name }}
                    <span class="ml-2 text-sm font-normal text-gray-500">({{ getEntradasVigentesDe(p.id!).length }} entradas vigentes)</span>
                  </h4>
                  
                  <div *ngIf="getEntradasVigentesDe(p.id!).length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Lote</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ingreso</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
                          <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Stock Restante</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unidad Control</th>
                          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Proveedor</th>
                          <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Estado</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100">
                        <tr *ngFor="let entrada of getEntradasVigentesDe(p.id!)" class="hover:bg-gray-50">
                          <td class="px-3 py-2 font-medium">{{ entrada.codigoLote || '-' }}</td>
                          <td class="px-3 py-2">{{ entrada.fechaIngreso ? (toDate(entrada.fechaIngreso) | date:'dd/MM/yyyy') : '-' }}</td>
                          <td class="px-3 py-2">
                            <span [ngClass]="esVencida(entrada) ? 'text-red-600 font-semibold' : (esPorVencer(entrada) ? 'text-orange-600' : '')">
                              {{ entrada.fechaVencimiento ? (toDate(entrada.fechaVencimiento) | date:'dd/MM/yyyy') : 'Sin venc.' }}
                              <i *ngIf="esVencida(entrada)" class="fas fa-exclamation-circle ml-1"></i>
                              <i *ngIf="esPorVencer(entrada) && !esVencida(entrada)" class="fas fa-clock ml-1"></i>
                            </span>
                          </td>
                          <td class="px-3 py-2 text-right font-semibold" [ngClass]="(entrada.stockBaseRestante || 0) <= 0 ? 'text-red-600' : 'text-green-600'">
                            {{ (entrada.stockBaseRestante || 0) | number:'1.0-2' }} {{ p.unitMeasurement?.name || 'kg' }}
                          </td>
                          <td class="px-3 py-2">{{ entrada.unidadControl || 'unidad' }}</td>
                          <td class="px-3 py-2">{{ entrada.provider?.name || '-' }}</td>
                          <td class="px-3 py-2 text-center">
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium"
                                  [ngClass]="entrada.activo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'">
                              {{ entrada.activo ? 'Vigente' : 'Cerrada' }}
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  
                  <div *ngIf="getEntradasVigentesDe(p.id!).length === 0" class="text-center py-4 text-gray-500">
                    <i class="fas fa-inbox text-2xl mb-2"></i>
                    <p>No hay entradas vigentes para este producto</p>
                    <button (click)="reponerProducto(p)" class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                      <i class="fas fa-plus-circle mr-1"></i> Crear Primera Entrada
                    </button>
                  </div>
                </div>
              </td>
            </tr>
            </ng-container>
            
            <!-- Mensaje si no hay productos -->
            <tr *ngIf="products.length === 0">
              <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                <i class="fas fa-box-open text-4xl text-gray-300 mb-3"></i>
                <p>No hay productos registrados. Cree productos en la pesta√±a "Productos".</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>