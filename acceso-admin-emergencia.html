<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acceso de Emergencia - Panel de Administrador</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: #f8f9fa;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .btn-success {
      background-color: #2ecc71;
    }
    .btn-danger {
      background-color: #e74c3c;
    }
    .output {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      font-weight: bold;
      margin: 10px 0;
    }
    .success { color: #2ecc71; }
    .error { color: #e74c3c; }
    .warning { color: #f39c12; }
    .links {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .links a {
      display: inline-block;
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Acceso de Emergencia - Panel de Administrador</h1>
    
    <div class="card">
      <h2>Diagnóstico de Tokens</h2>
      <p>Comprueba el estado actual de los tokens de autenticación:</p>
      <div id="status" class="status">Esperando diagnóstico...</div>
      <button onclick="diagnosticarTokens()">Verificar Tokens</button>
      <div id="output" class="output"></div>
    </div>
    
    <div class="card">
      <h2>Crear Token de Acceso</h2>
      <p>Crea un token de acceso de emergencia para el panel de administrador:</p>
      <button class="btn-success" onclick="crearTokenAdmin()">Crear Token de Administrador</button>
      <div id="tokenOutput" class="output"></div>
    </div>
    
    <div class="card">
      <h2>Acceder al Panel de Administrador</h2>
      <p>Una vez creado el token, utiliza estos enlaces para acceder al panel:</p>
      <div class="links">
        <a href="/admin/usuarios" target="_blank">Panel de Usuarios</a>
        <a href="/admin/dashboard" target="_blank">Dashboard Admin</a>
      </div>
    </div>
    
    <div class="card">
      <h2>Herramientas Avanzadas</h2>
      <button class="btn-danger" onclick="limpiarTokens()">Limpiar Todos los Tokens</button>
      <button onclick="probarBackend()">Probar Conexión con Backend</button>
      <div id="advancedOutput" class="output"></div>
    </div>
  </div>

  <script>
    // Función principal de diagnóstico
    function diagnosticarTokens() {
      const output = document.getElementById('output');
      const status = document.getElementById('status');
      
      output.textContent = "Analizando tokens de autenticación...";
      status.className = "status";
      status.textContent = "Analizando...";
      
      setTimeout(() => {
        let result = "";
        let hasValidTokens = false;
        
        // Comprobar tokens principales
        const authToken = localStorage.getItem('auth_token');
        const token = localStorage.getItem('token');
        const refreshToken = localStorage.getItem('refresh_token');
        const emergencyToken = localStorage.getItem('EMERGENCY_TOKEN');
        
        result += "== TOKENS DE ACCESO ==\n";
        
        if (authToken) {
          result += `✅ auth_token: ${authToken.substring(0, 15)}...\n`;
          hasValidTokens = true;
        } else {
          result += "❌ auth_token: No encontrado\n";
        }
        
        if (token) {
          result += `✅ token: ${token.substring(0, 15)}...\n`;
          hasValidTokens = true;
        } else {
          result += "❌ token: No encontrado\n";
        }
        
        if (refreshToken) {
          result += `✅ refresh_token: ${refreshToken.substring(0, 15)}...\n`;
        } else {
          result += "❌ refresh_token: No encontrado\n";
        }
        
        if (emergencyToken) {
          result += `✅ EMERGENCY_TOKEN: ${emergencyToken.substring(0, 15)}...\n`;
          hasValidTokens = true;
        } else {
          result += "❓ EMERGENCY_TOKEN: No encontrado (opcional)\n";
        }
        
        // Comprobar información de usuario
        result += "\n== INFORMACIÓN DE USUARIO ==\n";
        
        const userStr = localStorage.getItem('auth_user');
        const userStr2 = localStorage.getItem('user');
        let hasUserInfo = false;
        let isAdmin = false;
        
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            result += `✅ auth_user: ${user.username}\n`;
            
            if (user.roles && Array.isArray(user.roles)) {
              result += `✅ Roles: ${user.roles.join(', ')}\n`;
              isAdmin = user.roles.includes('ROLE_ADMIN');
            } else {
              result += "⚠️ El usuario no tiene roles definidos\n";
            }
            
            hasUserInfo = true;
          } catch (e) {
            result += `❌ Error al analizar auth_user: ${e.message}\n`;
          }
        } else {
          result += "❌ auth_user: No encontrado\n";
        }
        
        if (userStr2) {
          try {
            const user = JSON.parse(userStr2);
            result += `✅ user: ${user.username}\n`;
            hasUserInfo = true;
          } catch (e) {
            result += `❌ Error al analizar user: ${e.message}\n`;
          }
        } else {
          result += "❌ user: No encontrado\n";
        }
        
        // Verificar configuración adicional
        result += "\n== CONFIGURACIÓN ADICIONAL ==\n";
        
        const tokenExpiry = localStorage.getItem('token_expiry');
        if (tokenExpiry) {
          const expiryDate = new Date(parseInt(tokenExpiry));
          const now = new Date();
          const isExpired = expiryDate < now;
          
          if (isExpired) {
            result += `❌ Token expirado: ${expiryDate.toLocaleString()}\n`;
          } else {
            result += `✅ Fecha de expiración: ${expiryDate.toLocaleString()}\n`;
          }
        } else {
          result += "❌ No hay fecha de expiración establecida\n";
        }
        
        const bypassAuth = localStorage.getItem('bypass_auth') === 'true';
        if (bypassAuth) {
          result += "✅ Bypass de autenticación activado\n";
          hasValidTokens = true;
        }
        
        // Diagnóstico final
        result += "\n== DIAGNÓSTICO FINAL ==\n";
        
        if (hasValidTokens && hasUserInfo && isAdmin) {
          result += "✅ Todo parece correcto. Deberías poder acceder al panel de administrador.\n";
          status.className = "status success";
          status.textContent = "Todo correcto - Intenta acceder al panel";
        } else if (hasValidTokens && hasUserInfo) {
          result += "⚠️ Tienes tokens y datos de usuario, pero podrías no tener permisos de administrador.\n";
          status.className = "status warning";
          status.textContent = "Autenticación parcial - Faltan permisos";
        } else if (hasValidTokens) {
          result += "⚠️ Tienes tokens, pero falta información de usuario. Crea un nuevo token.\n";
          status.className = "status warning";
          status.textContent = "Tokens presentes - Faltan datos de usuario";
        } else {
          result += "❌ No se encontraron tokens válidos. Crea un nuevo token de administrador.\n";
          status.className = "status error";
          status.textContent = "Sin acceso - Se requiere crear token";
        }
        
        output.textContent = result;
      }, 500);
    }
    
    // Crear token de administrador
    function crearTokenAdmin() {
      const output = document.getElementById('tokenOutput');
      output.textContent = "Creando token de administrador...";
      
      setTimeout(() => {
        try {
          // Crear un token JWT básico
          const header = btoa(JSON.stringify({alg: "HS256", typ: "JWT"}));
          const now = Math.floor(Date.now() / 1000);
          const expiry = now + (24 * 60 * 60); // 24 horas
          const payload = btoa(JSON.stringify({
            sub: "admin",
            name: "Administrador",
            roles: ["ROLE_ADMIN"],
            iat: now,
            exp: expiry
          }));
          const signature = btoa("emergency_signature_" + now);
          
          // Crear el token completo
          const token = `${header}.${payload}.${signature}`;
          
          // Guardar tokens
          localStorage.setItem('auth_token', token);
          localStorage.setItem('token', token);
          localStorage.setItem('refresh_token', token);
          localStorage.setItem('EMERGENCY_TOKEN', token);
          
          // Crear objeto de usuario
          const userData = {
            id: 1,
            username: "admin",
            name: "Administrador",
            email: "admin@example.com",
            roles: ["ROLE_ADMIN"],
            token: token,
            refreshToken: token,
            sessionTimestamp: Date.now()
          };
          
          // Guardar datos de usuario
          localStorage.setItem('auth_user', JSON.stringify(userData));
          localStorage.setItem('user', JSON.stringify(userData));
          localStorage.setItem('current_user', JSON.stringify(userData));
          localStorage.setItem('user_roles', JSON.stringify(["ROLE_ADMIN"]));
          
          // Establecer fecha de expiración
          const expiryDate = new Date();
          expiryDate.setHours(expiryDate.getHours() + 24);
          localStorage.setItem('token_expiry', expiryDate.getTime().toString());
          
          // Configuración adicional para desarrollo
          localStorage.setItem('session_active', 'true');
          localStorage.setItem('session_timestamp', Date.now().toString());
          localStorage.setItem('bypass_auth', 'true');
          
          output.textContent = "✅ Token de administrador creado exitosamente!\n" +
                             "Ahora tienes acceso al panel de administrador durante 24 horas.\n" +
                             "Puedes usar los enlaces en la sección 'Acceder al Panel de Administrador'.";
          
          // Actualizar el estado
          const status = document.getElementById('status');
          status.className = "status success";
          status.textContent = "Token creado - Acceso disponible";
          
          // Actualizar diagnóstico
          diagnosticarTokens();
        } catch (e) {
          output.textContent = `❌ Error al crear token: ${e.message}`;
        }
      }, 500);
    }
    
    // Limpiar todos los tokens
    function limpiarTokens() {
      if (!confirm("¿Estás seguro de que deseas eliminar todos los tokens de autenticación?")) {
        return;
      }
      
      const output = document.getElementById('advancedOutput');
      output.textContent = "Limpiando todos los tokens...";
      
      setTimeout(() => {
        try {
          const tokenKeys = [
            'auth_token', 'token', 'refresh_token', 'EMERGENCY_TOKEN',
            'auth_user', 'user', 'current_user', 'user_roles',
            'token_expiry', 'session_active', 'session_timestamp', 'bypass_auth'
          ];
          
          tokenKeys.forEach(key => localStorage.removeItem(key));
          
          output.textContent = "✅ Se han eliminado todos los tokens de autenticación.\n" +
                             "Ya no tienes acceso al panel de administrador.\n" +
                             "Usa 'Crear Token de Administrador' para recuperar el acceso.";
          
          // Actualizar el estado
          const status = document.getElementById('status');
          status.className = "status error";
          status.textContent = "Sin acceso - Tokens eliminados";
          
          // Actualizar diagnóstico
          diagnosticarTokens();
        } catch (e) {
          output.textContent = `❌ Error al limpiar tokens: ${e.message}`;
        }
      }, 500);
    }
    
    // Probar conexión con el backend
    function probarBackend() {
      const output = document.getElementById('advancedOutput');
      output.textContent = "Probando conexión con el backend...";
      
      // Determinar la URL del backend (asumiendo que es localhost:8088)
      const backendUrl = "http://localhost:8088/health";
      
      fetch(backendUrl)
        .then(response => {
          if (response.ok) {
            return response.text().then(text => {
              output.textContent = `✅ Conexión exitosa con el backend!\n` +
                                 `Respuesta: ${text || "OK"}\n` +
                                 `El backend está funcionando correctamente.`;
            });
          } else {
            output.textContent = `❌ Error al conectar con el backend: ${response.status} ${response.statusText}`;
          }
        })
        .catch(error => {
          output.textContent = `❌ No se pudo conectar con el backend: ${error.message}\n` +
                             `Asegúrate de que el servidor backend está en ejecución en ${backendUrl}`;
        });
    }
    
    // Ejecutar diagnóstico al cargar la página
    window.onload = diagnosticarTokens;
  </script>
</body>
</html>
