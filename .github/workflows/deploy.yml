name: Build and Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up job
      run: |
        echo "ğŸš€ Starting deployment to production server..."
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"

    - name: Deploy and Restart Docker Compose
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 60s
        command_timeout: 300s
        script: |
          echo "ğŸ”„ Starting deployment process..."
          
          # Navegar al directorio del proyecto
          cd /opt/pollos-chanchos-Angular || { echo "âŒ Error: Directory not found"; exit 1; }
          
          # Hacer backup antes de actualizar
          echo "ğŸ“¦ Creating backup..."
          cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
          
          # Actualizar cÃ³digo desde GitHub
          echo "ğŸ“¥ Pulling latest code..."
          git stash || true
          git pull origin main || { echo "âŒ Error: Git pull failed"; exit 1; }
          
          # Compilar backend
          echo "ğŸ”¨ Building backend..."
          cd backend
          ./mvnw clean package -DskipTests || { echo "âŒ Error: Maven build failed"; exit 1; }
          cd ..
          
          # Detener contenedores actuales
          echo "ğŸ›‘ Stopping current containers..."
          docker-compose down || true
          
          # Limpiar recursos de Docker
          echo "ğŸ§¹ Cleaning Docker resources..."
          docker system prune -f || true
          
          # Construir y levantar nuevos contenedores
          echo "ğŸš€ Starting new containers..."
          docker-compose up --build -d || { echo "âŒ Error: Docker compose failed"; exit 1; }
          
          # Verificar estado de los contenedores
          echo "ğŸ“Š Checking container status..."
          sleep 10
          docker-compose ps
          
          # Verificar logs si hay errores
          if ! docker-compose ps | grep -q "Up"; then
            echo "âš ï¸ Some containers may have issues. Checking logs..."
            docker-compose logs --tail=50
          fi
          
          echo "âœ… Deployment completed successfully!"

    - name: Post Checkout code
      run: echo "âœ… Deployment process completed"

    - name: Complete job
      run: |
        echo "ğŸ‰ Production deployment finished!"
        echo "ğŸŒ Application should be available at: http://${{ secrets.SERVER_HOST }}:8088"