name: Build and Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: "60s"
        command_timeout: "1200s"
        script: |
          echo "🚀 Starting deployment process..."
          
          # Navegar al directorio del proyecto
          cd /opt/pollos-chanchos-Angular || { echo "❌ Directory not found"; exit 1; }
          
          # Hacer backup del docker-compose actual
          echo "📦 Creating backup..."
          cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S) || true
          
          # Actualizar código desde GitHub
          echo "📥 Updating code from GitHub..."
          git stash || true
          git pull origin main || { echo "❌ Git pull failed"; exit 1; }
          
          # Compilación del backend eliminada: ahora todo el build ocurre dentro de Docker
          
          # Detener contenedores
          echo "🛑 Stopping containers..."
          docker-compose down || true
          
          # Limpiar recursos de Docker
          echo "🧹 Cleaning Docker resources..."
          docker system prune -f || true
          
          # Construir y levantar contenedores
          echo "🚀 Starting containers..."
          docker-compose up --build -d || { echo "❌ Docker compose failed"; exit 1; }
          
          # Verificar estado
          echo "📊 Checking container status..."
          sleep 10
          docker-compose ps
          
          echo "✅ Deployment completed successfully!"

    - name: Deployment Complete
      run: |
        echo "🎉 Production deployment finished!"
        echo "🌐 Backend available at: http://${{ secrets.SERVER_HOST }}:8088"
        echo "🌐 Frontend available at: http://${{ secrets.SERVER_HOST }}:4200"